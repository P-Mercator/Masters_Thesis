<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-10-29 Sun 22:31 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Clustering large number of time series.</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Pierre Mercatoris" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/bigblow.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Clustering large number of time series.</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org91e64a5">1. Project Summary:</a></li>
<li><a href="#orgc87913b">2. Preparing the data</a>
<ul>
<li><a href="#org7d57069">2.1. Quality control</a></li>
</ul>
</li>
<li><a href="#org897d1df">3. Calculation of GCC</a></li>
<li><a href="#org59c1459">4. References:</a></li>
</ul>
</div>
</div>


<div id="outline-container-org91e64a5" class="outline-2">
<h2 id="org91e64a5"><span class="section-number-2">1</span> Project Summary:</h2>
<div class="outline-text-2" id="text-1">
<p>
The dynamic factor model is a well established modeling strategy when we face a large number of time series which makes it impossible to use standard multivariate techniques such as VARIMA models. Those time series could share some common factor but also the factors can have a group structure. Ando and Bai (2016) propose an iterative procedure for estimating a factor model with grouped factor structures. The starting step of the procedure relies on k-means algorithm and Euclidean metric on the original time series. It is known that Euclidean distance does not take into account the dependence among the individuals (time series in our case). In this project, we will consider other algorithms and metrics as starting step of the Ando and Bai’s procedure. We will evaluate the forecasting performance of the original and the proposed modification. The evaluation will consist of an extensive simulation study and its application to time series of the electricity market.
</p>

<ul class="org-ul">
<li>Professor: Andrés Alonso (andres.alonso@uc3m.es) and Daniel Peña (daniel.pena@uc3m.es).</li>
</ul>
</div>
</div>

<div id="outline-container-orgc87913b" class="outline-2">
<h2 id="orgc87913b"><span class="section-number-2">2</span> Preparing the data</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">from</span> os.path <span style="color: #0000FF;">import</span> join
<span style="color: #0000FF;">import</span> glob
<span style="color: #0000FF;">from</span> scipy.stats.mstats <span style="color: #0000FF;">import</span> zscore
<span style="color: #0000FF;">import</span> src.helpers <span style="color: #0000FF;">as</span> helpers
</pre>
</div>

<p>
I have downloaded all the regions definitive annual data from 2013 to 2015, the
consolidated 2016 data as well as the running 2017 data. 
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">data_path</span> = <span style="color: #008000;">"data"</span>

<span style="color: #BA36A5;">data</span> = pd.concat<span style="color: #707183;">(</span><span style="color: #7388D6;">[</span>
    pd.read_table<span style="color: #909183;">(</span>
        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">file, encoding="mac_roman", delimiter="\t", engine="python",</span>
        <span style="color: #006FE0;">file</span>, encoding=<span style="color: #008000;">"iso8859_1"</span>, delimiter=<span style="color: #008000;">"\t"</span>, engine=<span style="color: #008000;">"python"</span>,
        index_col=<span style="color: #D0372D;">False</span><span style="color: #909183;">)</span>.iloc<span style="color: #909183;">[</span><span style="color: #D0372D;">1</span>:-<span style="color: #D0372D;">1</span>, :<span style="color: #909183;">]</span>
    <span style="color: #0000FF;">for</span> <span style="color: #006FE0;">file</span> <span style="color: #0000FF;">in</span> glob.glob<span style="color: #909183;">(</span>join<span style="color: #709870;">(</span>data_path, <span style="color: #008000;">"*.xls"</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
</pre>
</div>



<p>
After reading the data I made sure that the "Consommation" is read as a numeric
and read the date as a python Datetime.
Although the table has rows for every 15 minutes, there exist on records every
30 minutes. I have therefore removed all those empty rows.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">data</span> = data.reset_index<span style="color: #707183;">(</span>drop=<span style="color: #D0372D;">True</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">data</span><span style="color: #707183;">[</span><span style="color: #008000;">"Consommation"</span><span style="color: #707183;">]</span> = pd.to_numeric<span style="color: #707183;">(</span>data<span style="color: #7388D6;">[</span><span style="color: #008000;">"Consommation"</span><span style="color: #7388D6;">]</span>, errors=<span style="color: #008000;">'coerce'</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">data</span> = data.loc<span style="color: #707183;">[</span>~data<span style="color: #7388D6;">[</span><span style="color: #008000;">"Consommation"</span><span style="color: #7388D6;">]</span>.isnull<span style="color: #7388D6;">()</span>, :<span style="color: #707183;">]</span>
<span style="color: #BA36A5;">data</span><span style="color: #707183;">[</span><span style="color: #008000;">"Datetime"</span><span style="color: #707183;">]</span> = pd.to_datetime<span style="color: #707183;">(</span>
    <span style="color: #7388D6;">(</span>data<span style="color: #909183;">[</span><span style="color: #008000;">"Date"</span><span style="color: #909183;">]</span> + <span style="color: #008000;">'_'</span> + data<span style="color: #909183;">[</span><span style="color: #008000;">"Heures"</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>.<span style="color: #006FE0;">apply</span><span style="color: #7388D6;">(</span><span style="color: #006FE0;">str</span><span style="color: #7388D6;">)</span>, <span style="color: #006FE0;">format</span>=<span style="color: #008000;">'%Y-%m-%d_%H:%M'</span><span style="color: #707183;">)</span>
</pre>
</div>


<p>
Finally, in order to get 1 time series per region, I have used a pivot on the
"Consommation"column, resulting in a table where the columns are the regions and
the rows are the 30 minutes electricity consumption measurements.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">consommation</span> = pd.pivot_table<span style="color: #707183;">(</span>data, values=<span style="color: #008000;">'Consommation'</span>,
                              index=<span style="color: #008000;">'Datetime'</span>, columns=<span style="color: #008000;">"P\351rim\350tre"</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">consommation.columns.name</span> = <span style="color: #008000;">"Perimetre"</span>
<span style="color: #BA36A5;">consommation</span> = consommation.resample<span style="color: #707183;">(</span><span style="color: #008000;">"30T"</span><span style="color: #707183;">)</span>.mean<span style="color: #707183;">()</span>
<span style="color: #BA36A5;">consommation</span> = consommation.drop<span style="color: #707183;">(</span><span style="color: #008000;">'France'</span>, axis=<span style="color: #D0372D;">1</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>


<div id="outline-container-org7d57069" class="outline-3">
<h3 id="org7d57069"><span class="section-number-3">2.1</span> Quality control</h3>
<div class="outline-text-3" id="text-2-1">
<p>
To assure that I only proceed with good data, I have deleted all the
regions that did not have 50% of the data.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Good series have more than 50% data</span>
<span style="color: #BA36A5;">good_series</span> = <span style="color: #707183;">[</span>
    consommation.iloc<span style="color: #7388D6;">[</span>:, i<span style="color: #7388D6;">]</span>.isnull<span style="color: #7388D6;">()</span>.<span style="color: #006FE0;">sum</span><span style="color: #7388D6;">()</span> / consommation.iloc<span style="color: #7388D6;">[</span>:, i<span style="color: #7388D6;">]</span>.shape<span style="color: #7388D6;">[</span><span style="color: #D0372D;">0</span><span style="color: #7388D6;">]</span> &lt;
    <span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">50</span> <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span><span style="color: #7388D6;">(</span>consommation.shape<span style="color: #909183;">[</span><span style="color: #D0372D;">1</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
<span style="color: #707183;">]</span>
<span style="color: #BA36A5;">consommation</span> = consommation.loc<span style="color: #707183;">[</span>:, good_series<span style="color: #707183;">]</span>
</pre>
</div>

<p>
Furthermore, the data now contains some weird outliers:
</p>


<div class="figure">
<p><img src="img/outliers.png" alt="outliers.png" />
</p>
</div>

<p>
To get rid of those, I have removed those outliers by using a running median
of 30 days and a maximum difference of 2.5 standard deviation of the time
series compared to that median. Then, I have replaced the null values using
linear interpolation.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">clean_series</span><span style="color: #707183;">(</span>ts<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">ts</span> = remove_outliers<span style="color: #707183;">(</span>ts<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">ts</span> = ts.interpolate<span style="color: #707183;">(</span><span style="color: #008000;">"time"</span><span style="color: #707183;">)</span>
    <span style="color: #0000FF;">return</span> ts


<span style="color: #0000FF;">def</span> <span style="color: #006699;">remove_outliers</span><span style="color: #707183;">(</span>ts<span style="color: #707183;">)</span>:
    <span style="color: #036A07;">"""</span>
<span style="color: #036A07;">    Remove values where absolute difference with rolling median is more </span>
<span style="color: #036A07;">    than 2.5 standard deviation</span>
<span style="color: #036A07;">    """</span>
    <span style="color: #0000FF;">return</span> ts<span style="color: #707183;">[</span><span style="color: #006FE0;">abs</span><span style="color: #7388D6;">(</span>ts - ts.rolling<span style="color: #909183;">(</span><span style="color: #008000;">'30d'</span><span style="color: #909183;">)</span>.median<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span> &lt; <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">5</span> * ts.std<span style="color: #7388D6;">()</span><span style="color: #707183;">]</span>


<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Remove outliers and interpolate missing values</span>
<span style="color: #BA36A5;">consommation</span> = consommation.<span style="color: #006FE0;">apply</span><span style="color: #707183;">(</span>clean_series, axis=<span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>.resample<span style="color: #707183;">(</span><span style="color: #008000;">'30T'</span><span style="color: #707183;">)</span>.mean<span style="color: #707183;">()</span>
</pre>
</div>


<div class="figure">
<p><img src="img/outliers_removed.png" alt="outliers_removed.png" />
</p>
</div>


<p>
To get stationary data with a mean approaching 0 and a variance approaching 1, I have calculated the moving
difference between measurements and converted those values to zscore.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">consommation</span> = consommation.diff<span style="color: #707183;">()</span>.fillna<span style="color: #707183;">(</span><span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>.<span style="color: #006FE0;">apply</span><span style="color: #707183;">(</span>zscore, axis=<span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">consommation.var<span style="color: #707183;">()</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython">consommation.mean<span style="color: #707183;">()</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org897d1df" class="outline-2">
<h2 id="org897d1df"><span class="section-number-2">3</span> Calculation of GCC</h2>
<div class="outline-text-2" id="text-3">
<p>
The data should now be in the correct format to calculate the GCC between
the series. But in order to be sure the computation is correct, am trying
it on 2 dummy series.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #BA36A5;">ts1</span> = np.array<span style="color: #707183;">(</span><span style="color: #7388D6;">[</span>-<span style="color: #D0372D;">1</span>.<span style="color: #D0372D;">5</span>, -<span style="color: #D0372D;">1</span>. , -<span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span>,  <span style="color: #D0372D;">0</span>. ,  <span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span>,  <span style="color: #D0372D;">1</span>. ,  <span style="color: #D0372D;">1</span>.<span style="color: #D0372D;">5</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">ts2</span> = ts1 * <span style="color: #D0372D;">1</span>
</pre>
</div>

<p>
With k of 3, I have made sure to convert each series into a "lag matrix".
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">k_matrix</span><span style="color: #707183;">(</span>ts, k<span style="color: #707183;">)</span>:
    <span style="color: #0000FF;">return</span> np.array<span style="color: #707183;">(</span><span style="color: #7388D6;">[</span>ts<span style="color: #909183;">[</span><span style="color: #709870;">(</span>shift<span style="color: #709870;">)</span>:ts.shape<span style="color: #709870;">[</span><span style="color: #D0372D;">0</span><span style="color: #709870;">]</span> - k + shift<span style="color: #909183;">]</span>
                     <span style="color: #0000FF;">for</span> shift <span style="color: #0000FF;">in</span> np.arange<span style="color: #909183;">(</span><span style="color: #D0372D;">0</span>, k + <span style="color: #D0372D;">1</span><span style="color: #909183;">)</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>.T


<span style="color: #BA36A5;">k</span> = <span style="color: #D0372D;">3</span>
<span style="color: #BA36A5;">T</span> = ts1.shape<span style="color: #707183;">[</span><span style="color: #D0372D;">0</span><span style="color: #707183;">]</span>
<span style="color: #BA36A5;">Xi</span> = k_matrix<span style="color: #707183;">(</span>ts1, <span style="color: #D0372D;">3</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">Xj</span> = k_matrix<span style="color: #707183;">(</span>ts2, <span style="color: #D0372D;">3</span><span style="color: #707183;">)</span>

<span style="color: #BA36A5;">Xij</span> = np.concatenate<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>Xi, Xj<span style="color: #7388D6;">)</span>, axis=<span style="color: #D0372D;">1</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">print</span><span style="color: #707183;">(</span><span style="color: #008000;">"Xi = "</span>, Xi<span style="color: #707183;">)</span>
<span style="color: #0000FF;">print</span><span style="color: #707183;">(</span><span style="color: #008000;">"\n"</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">print</span><span style="color: #707183;">(</span><span style="color: #008000;">"Xj = "</span>, Xj<span style="color: #707183;">)</span>
<span style="color: #0000FF;">print</span><span style="color: #707183;">(</span><span style="color: #008000;">"\n"</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">print</span><span style="color: #707183;">(</span><span style="color: #008000;">"Xij = "</span>, Xij<span style="color: #707183;">)</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Xi =  [[-1.5 -1.  -0.5  0. ]
 [-1.  -0.5  0.   0.5]
 [-0.5  0.   0.5  1. ]
 [ 0.   0.5  1.   1.5]]


Xj =  [[-1.5 -1.  -0.5  0. ]
 [-1.  -0.5  0.   0.5]
 [-0.5  0.   0.5  1. ]
 [ 0.   0.5  1.   1.5]]


Xij =  [[-1.5 -1.  -0.5  0.  -1.5 -1.  -0.5  0. ]
 [-1.  -0.5  0.   0.5 -1.  -0.5  0.   0.5]
 [-0.5  0.   0.5  1.  -0.5  0.   0.5  1. ]
 [ 0.   0.5  1.   1.5  0.   0.5  1.   1.5]]
</pre>
</div>

<p>
Then trying a few different ways of calculation the correlation matrix, I am
struggling to get a correct value for GCC:
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">corr_matrix</span><span style="color: #707183;">(</span>X<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">I</span> = np.identity<span style="color: #707183;">(</span>X.shape<span style="color: #7388D6;">[</span><span style="color: #D0372D;">0</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">ones</span> = np.ones<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span><span style="color: #D0372D;">1</span>,X.shape<span style="color: #909183;">[</span><span style="color: #D0372D;">0</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">P</span> = I - ones * ones.T / <span style="color: #707183;">(</span>X.shape<span style="color: #7388D6;">[</span><span style="color: #D0372D;">0</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">S</span> = np.dot<span style="color: #707183;">(</span>np.dot<span style="color: #7388D6;">(</span>X.T, P<span style="color: #7388D6;">)</span>, X<span style="color: #707183;">)</span> / <span style="color: #707183;">(</span>X.shape<span style="color: #7388D6;">[</span><span style="color: #D0372D;">0</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">D</span> = np.diagonal<span style="color: #707183;">(</span>S<span style="color: #707183;">)</span>
    <span style="color: #0000FF;">return</span> D**-<span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span> * S * D**-<span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span>

<span style="color: #BA36A5;">GCC</span> =  <span style="color: #D0372D;">1</span>- np.linalg.det<span style="color: #707183;">(</span>corr_matrix<span style="color: #7388D6;">(</span>Xij<span style="color: #7388D6;">)</span> ** <span style="color: #7388D6;">(</span><span style="color: #D0372D;">1</span>/<span style="color: #D0372D;">2</span>*<span style="color: #909183;">(</span>k+<span style="color: #D0372D;">1</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> / <span style="color: #707183;">(</span>
    np.linalg.det<span style="color: #7388D6;">(</span>corr_matrix<span style="color: #909183;">(</span>Xi<span style="color: #909183;">)</span> ** <span style="color: #909183;">(</span><span style="color: #D0372D;">1</span> / <span style="color: #D0372D;">2</span> * <span style="color: #709870;">(</span>k + <span style="color: #D0372D;">1</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> \
    * np.linalg.det<span style="color: #7388D6;">(</span>corr_matrix<span style="color: #909183;">(</span>Xj<span style="color: #909183;">)</span> ** <span style="color: #909183;">(</span><span style="color: #D0372D;">1</span> / <span style="color: #D0372D;">2</span> * <span style="color: #709870;">(</span>k + <span style="color: #D0372D;">1</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

GCC

</pre>
</div>

<pre class="example">
nan

</pre>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">def</span> <span style="color: #006699;">corr_matrix</span><span style="color: #707183;">(</span>X<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">S</span> = np.cov<span style="color: #707183;">(</span>X<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">D</span> = np.diagonal<span style="color: #707183;">(</span>S<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">R</span> = D**-<span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span> * S * D**-<span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span>
    <span style="color: #0000FF;">return</span> D**-<span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span> * S * D**-<span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">5</span>

<span style="color: #BA36A5;">GCC</span> =  <span style="color: #D0372D;">1</span>- np.linalg.det<span style="color: #707183;">(</span>corr_matrix<span style="color: #7388D6;">(</span>Xij<span style="color: #7388D6;">)</span> ** <span style="color: #7388D6;">(</span><span style="color: #D0372D;">1</span>/<span style="color: #D0372D;">2</span>*<span style="color: #909183;">(</span>k+<span style="color: #D0372D;">1</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> / <span style="color: #707183;">(</span>
    np.linalg.det<span style="color: #7388D6;">(</span>corr_matrix<span style="color: #909183;">(</span>Xi<span style="color: #909183;">)</span> ** <span style="color: #909183;">(</span><span style="color: #D0372D;">1</span> / <span style="color: #D0372D;">2</span> * <span style="color: #709870;">(</span>k + <span style="color: #D0372D;">1</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> \
    * np.linalg.det<span style="color: #7388D6;">(</span>corr_matrix<span style="color: #909183;">(</span>Xj<span style="color: #909183;">)</span> ** <span style="color: #909183;">(</span><span style="color: #D0372D;">1</span> / <span style="color: #D0372D;">2</span> * <span style="color: #709870;">(</span>k + <span style="color: #D0372D;">1</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

GCC
</pre>
</div>

<pre class="example">
nan

</pre>
</div>
</div>

<div id="outline-container-org59c1459" class="outline-2">
<h2 id="org59c1459"><span class="section-number-2">4</span> References:</h2>
<div class="outline-text-2" id="text-4">
<p>
Ando, T. and Bai, J. (2016) Clustering huge number of financial time series: A panel data approach with high-dimensional predictors and factor structures. To appear at JASA. Available at: <a href="http://dx.doi.org/10.1080/01621459.2016.1195743">http://dx.doi.org/10.1080/01621459.2016.1195743</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Pierre Mercatoris</p>
<p class="date">Created: 2017-10-29 Sun 22:31</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
