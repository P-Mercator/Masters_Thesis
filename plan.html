<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-03-11 Sun 19:49 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Clustering large number of time series.</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Pierre Mercatoris" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/bigblow.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Clustering large number of time series.</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge30d67d">1. Preparing the data</a>
<ul>
<li><a href="#org52af9b1">1.1. Reading the data</a>
<ul>
<li><a href="#org1415eea">1.1.1. In Python</a></li>
<li><a href="#org220d5a8">1.1.2. In R (NOT USED ANYMORE!)</a></li>
</ul>
</li>
<li><a href="#orge89a232">1.2. Transform the data</a>
<ul>
<li><a href="#orga1d2898">1.2.1. Stationarity</a></li>
<li><a href="#org1a0496a">1.2.2. Data standardisation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge097ce9">2. Calculation of GCC</a>
<ul>
<li><a href="#orgf290815">2.1. Selection of k</a>
<ul>
<li><a href="#org216dea9">2.1.1. PACF</a></li>
<li><a href="#org87cc9e2">2.1.2. AR model fitting</a></li>
</ul>
</li>
<li><a href="#org4e37e4f">2.2. GCC</a></li>
</ul>
</li>
<li><a href="#org1cf9966">3. Clustering</a>
<ul>
<li><a href="#orgedf2dc8">3.1. Determination of the number of clusters</a></li>
<li><a href="#org847f219">3.2. Clustering methods comparison</a></li>
</ul>
</li>
<li><a href="#org5844edb">4. Plot Clusters</a>
<ul>
<li><a href="#org33b8958">4.1. Mapping the clusters</a></li>
<li><a href="#org3bd5ab7">4.2. Check within regions clusters</a></li>
</ul>
</li>
<li><a href="#org2c3d61b">5. References:</a></li>
</ul>
</div>
</div>


<div id="outline-container-orge30d67d" class="outline-2">
<h2 id="orge30d67d"><span class="section-number-2">1</span> Preparing the data</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org52af9b1" class="outline-3">
<h3 id="org52af9b1"><span class="section-number-3">1.1</span> Reading the data</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org1415eea" class="outline-4">
<h4 id="org1415eea"><span class="section-number-4">1.1.1</span> In Python</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
I have downloaded all the regions' annual data from 2013 to 2015, the
consolidated 2016 data as well as the running 2017 data. The data came split
between files for each 12 regions of France and each year, where each record
contains the date, the time, the region and the electricity consumption.
</p>

<p>
I have needed to correct the names of the regions as those where changed
(probably by error) on the 29th of February 2016. 
</p>

<p>
<a href="http://www.rte-france.com/en/eco2mix/eco2mix-telechargement-en">http://www.rte-france.com/en/eco2mix/eco2mix-telechargement-en</a>
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> os.path <span style="color: #4f97d7; font-weight: bold;">import</span> join
<span style="color: #4f97d7; font-weight: bold;">import</span> glob
<span style="color: #4f97d7; font-weight: bold;">import</span> pandas <span style="color: #4f97d7; font-weight: bold;">as</span> pd

<span style="color: #7590db;">data_path</span> = <span style="color: #2d9574;">"data"</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Combine all the .xls of each region</span>
<span style="color: #7590db;">data</span> = pd.concat<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>
    pd.read_table<span style="color: #2d9574;">(</span>
        <span style="color: #4f97d7;">file</span>, encoding=<span style="color: #2d9574;">"cp1252"</span>, delimiter=<span style="color: #2d9574;">"\t"</span>, engine=<span style="color: #2d9574;">"python"</span>,
        index_col=<span style="color: #a45bad;">False</span><span style="color: #2d9574;">)</span>.iloc<span style="color: #2d9574;">[</span>:-<span style="color: #a45bad;">1</span>, :<span style="color: #2d9574;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">file</span> <span style="color: #4f97d7; font-weight: bold;">in</span> glob.glob<span style="color: #2d9574;">(</span>join<span style="color: #67b11d;">(</span>data_path, <span style="color: #2d9574;">"*.xls"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Format type of variables</span>
<span style="color: #7590db;">data</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Consommation"</span><span style="color: #4f97d7;">]</span> = pd.to_numeric<span style="color: #4f97d7;">(</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Consommation"</span><span style="color: #bc6ec5;">]</span>, errors=<span style="color: #2d9574;">'coerce'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">data</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Datetime"</span><span style="color: #4f97d7;">]</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>
    <span style="color: #bc6ec5;">(</span>data<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"Date"</span><span style="color: #2d9574;">]</span> + <span style="color: #2d9574;">'_'</span> + data<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"Heures"</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>.<span style="color: #4f97d7;">apply</span><span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">str</span><span style="color: #bc6ec5;">)</span>, <span style="color: #4f97d7;">format</span>=<span style="color: #2d9574;">'%Y-%m-%d_%H:%M'</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Correct regions names</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Auvergne et Rh&#244;ne-Alpes'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Auvergne-Rh&#244;ne-Alpes'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Bourgogne et Franche Comt&#233;'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Bourgogne-Franche-Comt&#233;'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Alsace, Champagne-Ardenne et Lorraine'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Grand-Est'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Nord-Pas-de-Calais et Picardie'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Hauts-de-France'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Aquitaine, Limousin et Poitou-Charentes'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Nouvelle-Aquitaine'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Languedoc-Roussillon et Midi-Pyr&#233;n&#233;es'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Occitanie'</span>

data.head<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
Périmètre               Nature        Date Heures  Consommation Thermique  \
0  Normandie  Données définitives  2013-01-01  00:00           NaN        ND
1  Normandie  Données définitives  2013-01-01  00:15           NaN       NaN
2  Normandie  Données définitives  2013-01-01  00:30        3683.0       432
3  Normandie  Données définitives  2013-01-01  00:45           NaN       NaN
4  Normandie  Données définitives  2013-01-01  01:00        3549.0       433

Nucléaire Eolien Solaire Hydraulique Pompage Bioénergies Ech. physiques  \
0        ND     ND      ND          ND      ND          ND             ND
1       NaN    NaN     NaN         NaN     NaN         NaN            NaN
2      8200    216       0          12       -          54          -5233
3       NaN    NaN     NaN         NaN     NaN         NaN            NaN
4      8224    190       0          12       -          54          -5366

Datetime
0 2013-01-01 00:00:00
1 2013-01-01 00:15:00
2 2013-01-01 00:30:00
3 2013-01-01 00:45:00
4 2013-01-01 01:00:00
</pre>

<p>
As all the regions are in the same columns, I have used a pivot table to get 1
column per region for each 'Datetime' (1 column for each of 12 regions). Additionally, it is important to set the timezone to UTC in order to account for
daylight saving time change and avoid removing data or introducing NAs.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Reshape to row = datetime and column = region, all values are consumption</span>
<span style="color: #7590db;">consommation</span> = pd.pivot_table<span style="color: #4f97d7;">(</span>
    data, values=<span style="color: #2d9574;">'Consommation'</span>, index=<span style="color: #2d9574;">'Datetime'</span>, columns=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Set timezone as it creates problem when changing between daylight saving times.</span>
<span style="color: #7590db;">consommation</span> = consommation.tz_localize<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'UTC'</span>, ambiguous=<span style="color: #a45bad;">False</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">consommation</span> = consommation.resample<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'30T'</span><span style="color: #4f97d7;">)</span>.mean<span style="color: #4f97d7;">()</span>

consommation.head<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
Périmètre                  Auvergne-Rhône-Alpes  Bourgogne-Franche-Comté  \
Datetime
2013-01-01 00:00:00+00:00                   NaN                      NaN
2013-01-01 00:30:00+00:00                8173.0                   2357.0
2013-01-01 01:00:00+00:00                7944.0                   2289.0
2013-01-01 01:30:00+00:00                7896.0                   2326.0
2013-01-01 02:00:00+00:00                7882.0                   2409.0

Périmètre                  Bretagne  Centre-Val de Loire  Grand-Est  \
Datetime
2013-01-01 00:00:00+00:00       NaN                  NaN        NaN
2013-01-01 00:30:00+00:00    3050.0               2476.0     4943.0
2013-01-01 01:00:00+00:00    2866.0               2319.0     4811.0
2013-01-01 01:30:00+00:00    2735.0               2560.0     4840.0
2013-01-01 02:00:00+00:00    2874.0               2395.0     4897.0

Périmètre                  Hauts-de-France  Ile-de-France  Normandie  \
Datetime
2013-01-01 00:00:00+00:00              NaN            NaN        NaN
2013-01-01 00:30:00+00:00           5989.0         9134.0     3683.0
2013-01-01 01:00:00+00:00           5832.0         8822.0     3549.0
2013-01-01 01:30:00+00:00           5926.0         8499.0     3570.0
2013-01-01 02:00:00+00:00           5695.0         8229.0     3569.0

Périmètre                  Nouvelle-Aquitaine  Occitanie    PACA  \
Datetime
2013-01-01 00:00:00+00:00                 NaN        NaN     NaN
2013-01-01 00:30:00+00:00              5464.0     5228.0  5570.0
2013-01-01 01:00:00+00:00              5422.0     4955.0  5698.0
2013-01-01 01:30:00+00:00              5514.0     4888.0  5680.0
2013-01-01 02:00:00+00:00              5443.0     4881.0  5577.0

Périmètre                  Pays-de-la-Loire
Datetime
2013-01-01 00:00:00+00:00               NaN
2013-01-01 00:30:00+00:00            3595.0
2013-01-01 01:00:00+00:00            3359.0
2013-01-01 01:30:00+00:00            3313.0
2013-01-01 02:00:00+00:00            3383.0
</pre>

<p>
In those 12 time series we can see some
outliers at the beginning of September 2017 where the data is close to 0. Those
gaps are expected as this data was not yet consolidated.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #4f97d7; font-weight: bold;">as</span> plt
%matplotlib inline

<span style="color: #7590db;">fig</span>, <span style="color: #7590db;">ax</span> = plt.subplots<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span>, <span style="color: #a45bad;">3</span>, sharex=<span style="color: #a45bad;">True</span>, sharey=<span style="color: #a45bad;">True</span><span style="color: #4f97d7;">)</span>
fig.set_size_inches<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">18</span>,<span style="color: #a45bad;">13</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>
<span style="color: #7590db;">row</span> = <span style="color: #a45bad;">0</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> column <span style="color: #4f97d7; font-weight: bold;">in</span> consommation.columns:
    <span style="color: #7590db;">col</span> = i % <span style="color: #a45bad;">3</span>
    consommation<span style="color: #4f97d7;">[</span>column<span style="color: #4f97d7;">]</span>.plot<span style="color: #4f97d7;">(</span>ax=ax<span style="color: #bc6ec5;">[</span>row, col<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">i</span> += <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> col == <span style="color: #a45bad;">2</span>:
        <span style="color: #7590db;">row</span> += <span style="color: #a45bad;">1</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/plotSeries.png" alt="plotSeries.png" />
</p>
</div>

<p>
In order to make sure we are using
clean data, I have decided to use the records from the 2nd of January 2013 (1st
doesn't have data for midnight) to the 2nd of January 2017.
</p>

<p>
Furthermore, a second pivot table was used in order to create a column for each
30 minutes of the day. This resulted in a table composed of 576 daily time
series (48 for each of the 12 regions) over 1455 days.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> datetime

<span style="color: #7590db;">consommation</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"date"</span><span style="color: #4f97d7;">]</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>consommation.index<span style="color: #4f97d7;">)</span>.date
<span style="color: #7590db;">consommation</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"time"</span><span style="color: #4f97d7;">]</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>consommation.index<span style="color: #4f97d7;">)</span>.time
<span style="color: #7590db;">consommation</span> = pd.pivot_table<span style="color: #4f97d7;">(</span>pd.melt<span style="color: #bc6ec5;">(</span>consommation, id_vars=<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"date"</span>, <span style="color: #2d9574;">"time"</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>,
                              index=<span style="color: #2d9574;">"date"</span>, values=<span style="color: #2d9574;">"value"</span>, columns=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"P&#233;rim&#232;tre"</span>, <span style="color: #2d9574;">"time"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">consommation = consommation.loc[datetime.date(2013,1,2):datetime.date(2017,1,2), :]</span>
<span style="color: #7590db;">consommation</span> = consommation.loc<span style="color: #4f97d7;">[</span>datetime.date<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2013</span>,<span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>:, :<span style="color: #4f97d7;">]</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Get rid of the 15 minutes columns (columns with nans)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">consommation = consommation.loc[:,consommation.isnull().sum()!=consommation.shape[0]]</span>

consommation.head<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
Périmètre  Auvergne-Rhône-Alpes                                               \
time                   00:00:00 00:30:00 01:00:00 01:30:00 02:00:00 02:30:00
date
2013-01-02               7847.0   7674.0   7427.0   7441.0   7467.0   7550.0
2013-01-03               9028.0   8839.0   8544.0   8560.0   8569.0   8667.0
2013-01-04               8982.0   8754.0   8476.0   8480.0   8453.0   8554.0
2013-01-05               8625.0   8465.0   8165.0   8134.0   8087.0   8149.0
2013-01-06               8314.0   8097.0   7814.0   7791.0   7785.0   7842.0

Périmètre                                        ...    Pays-de-la-Loire  \
time       03:00:00 03:30:00 04:00:00 04:30:00   ...            19:00:00
date                                             ...
2013-01-02   7434.0   7371.0   7233.0   7311.0   ...              4336.0
2013-01-03   8559.0   8483.0   8390.0   8392.0   ...              4279.0
2013-01-04   8436.0   8386.0   8224.0   8195.0   ...              4181.0
2013-01-05   7974.0   7897.0   7713.0   7597.0   ...              3877.0
2013-01-06   7670.0   7605.0   7418.0   7352.0   ...              3854.0

Périmètre                                                                  \
time       19:30:00 20:00:00 20:30:00 21:00:00 21:30:00 22:00:00 22:30:00
date
2013-01-02   4228.0   4079.0   3923.0   3756.0   3565.0   3457.0   3510.0
2013-01-03   4166.0   4038.0   3862.0   3712.0   3463.0   3308.0   3394.0
2013-01-04   4123.0   3946.0   3755.0   3597.0   3559.0   3412.0   3456.0
2013-01-05   3786.0   3696.0   3540.0   3449.0   3296.0   3221.0   3296.0
2013-01-06   3834.0   3826.0   3771.0   3631.0   3494.0   3423.0   3420.0

Périmètre
time       23:00:00 23:30:00
date
2013-01-02   4003.0   3710.0
2013-01-03   3909.0   3700.0
2013-01-04   3903.0   3662.0
2013-01-05   3864.0   3700.0
2013-01-06   3942.0   3717.0

[5 rows x 576 columns]
</pre>

<p>
With minimal data manipulation, I was able to format the data into 48 daily
series for each of the regions and get rid of all the 'missing' values.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Data dimensions: '</span>, consommation.shape<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Number of NA values: '</span>, consommation.isnull<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Data dimensions:  (1794, 576)
Number of NA values:  0

</pre>

<p>
As you can see, this gives us a matrix of 1794 rows (days) and 576 columns (48
half-hour of each 12 regions per day), with no NA values.
</p>

<p>
This data is now saved into a csv to read from R.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Merge multi index column names to read in R</span>
<span style="color: #7590db;">consommation.columns</span> = <span style="color: #4f97d7;">[</span>col<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> + <span style="color: #2d9574;">'_'</span> + <span style="color: #4f97d7;">str</span><span style="color: #bc6ec5;">(</span>col<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> col <span style="color: #4f97d7; font-weight: bold;">in</span> consommation.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Save to access from R</span>
consommation.to_csv<span style="color: #4f97d7;">(</span>join<span style="color: #bc6ec5;">(</span>data_path, <span style="color: #2d9574;">"consommation.csv"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">consommation = pd.read_csv(join(data_path, "consommation.csv"),index_col=[0], header=[0,1])</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org220d5a8" class="outline-4">
<h4 id="org220d5a8"><span class="section-number-4">1.1.2</span> In R (NOT USED ANYMORE!)</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>tidyverse<span style="color: #4f97d7;">)</span>
<span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>lubridate<span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">data <span style="color: #a45bad;">&lt;-</span> read.csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"data/all_raw.csv"</span>, row.names=<span style="color: #ce537a; font-weight: bold;">NULL</span>, encoding=<span style="color: #2d9574;">"cp1252"</span><span style="color: #4f97d7;">)</span>
data$Date <span style="color: #a45bad;">&lt;-</span> parse_date<span style="color: #4f97d7;">(</span>data$Date<span style="color: #4f97d7;">)</span>
data$Heures <span style="color: #a45bad;">&lt;-</span> parse_time<span style="color: #4f97d7;">(</span>data$Heures<span style="color: #4f97d7;">)</span>
data$Consommation <span style="color: #a45bad;">&lt;-</span> data$Consommation <span style="color: #a45bad;">%&gt;%</span>
  as.character<span style="color: #4f97d7;">()</span> <span style="color: #a45bad;">%&gt;%</span>
  parse_double<span style="color: #4f97d7;">(</span>na = c<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">""</span>, <span style="color: #2d9574;">"NA"</span>, <span style="color: #2d9574;">"-"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

data <span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  select<span style="color: #4f97d7;">(</span>c<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"P&#233;rim&#232;tre"</span>, <span style="color: #2d9574;">"Consommation"</span>, <span style="color: #2d9574;">"Date"</span>, <span style="color: #2d9574;">"Heures"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #a45bad;">%&gt;%</span>
  filter<span style="color: #4f97d7;">(</span>P&#233;rim&#232;tre != <span style="color: #2d9574;">"France"</span><span style="color: #4f97d7;">)</span>

goodRegions <span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  spread<span style="color: #4f97d7;">(</span>key=P&#233;rim&#232;tre, value = Consommation<span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
  is.na<span style="color: #4f97d7;">()</span> <span style="color: #a45bad;">%&gt;%</span>
  colMeans<span style="color: #4f97d7;">()</span> &lt; <span style="color: #a45bad;">0.5</span>

goodRegions<span style="color: #a45bad;">&lt;-</span> names<span style="color: #4f97d7;">(</span>which<span style="color: #bc6ec5;">(</span>goodRegions<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
data <span style="color: #a45bad;">&lt;-</span> data<span style="color: #4f97d7;">[</span>data$P&#233;rim&#232;tre <span style="color: #a45bad;">%in%</span> goodRegions, <span style="color: #4f97d7;">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>xts<span style="color: #4f97d7;">)</span>

data.byPerimetre<span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  spread<span style="color: #4f97d7;">(</span>key=P&#233;rim&#232;tre, value=Consommation<span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
  filter<span style="color: #4f97d7;">(</span>Date &gt; ymd<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"2013-01-01"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

dates <span style="color: #a45bad;">&lt;-</span> as.POSIXct<span style="color: #4f97d7;">(</span>paste<span style="color: #bc6ec5;">(</span>data.byPerimetre$Date, data.byPerimetre$Heures<span style="color: #bc6ec5;">)</span>, format=<span style="color: #2d9574;">"%Y-%m-%d %H:%M:%S"</span>, tz=<span style="color: #2d9574;">"UTC"</span><span style="color: #4f97d7;">)</span>
regions.xts <span style="color: #a45bad;">&lt;-</span> xts<span style="color: #4f97d7;">(</span>data.matrix<span style="color: #bc6ec5;">(</span>data.byPerimetre<span style="color: #2d9574;">[</span>, c<span style="color: #67b11d;">(</span>-<span style="color: #a45bad;">1</span>,-<span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>,order.by=dates<span style="color: #4f97d7;">)</span>

ep <span style="color: #a45bad;">&lt;-</span> endpoints<span style="color: #4f97d7;">(</span>regions.xts, <span style="color: #2d9574;">"minutes"</span>, k=<span style="color: #a45bad;">30</span><span style="color: #4f97d7;">)</span>
halfHour.xts <span style="color: #a45bad;">&lt;-</span> period.apply<span style="color: #4f97d7;">(</span>na.locf<span style="color: #bc6ec5;">(</span>regions.xts<span style="color: #bc6ec5;">)</span>, INDEX = ep, FUN = mean<span style="color: #4f97d7;">)</span>

plot.xts<span style="color: #4f97d7;">(</span>halfHour.xts<span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/r_xts_outliers.png" alt="r_xts_outliers.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">From 1st of september 2017, we get 15 minutes measurements</span>
data.byPerimetre<span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  spread<span style="color: #4f97d7;">(</span>key=P&#233;rim&#232;tre, value=Consommation<span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
  filter<span style="color: #4f97d7;">(</span>Date &gt; ymd<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"2013-01-01"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
    filter<span style="color: #4f97d7;">(</span>Date &lt; ymd<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"2017-09-01"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

dates <span style="color: #a45bad;">&lt;-</span> as.POSIXct<span style="color: #4f97d7;">(</span>paste<span style="color: #bc6ec5;">(</span>data.byPerimetre$Date, data.byPerimetre$Heures<span style="color: #bc6ec5;">)</span>, format=<span style="color: #2d9574;">"%Y-%m-%d %H:%M:%S"</span>, tz=<span style="color: #2d9574;">"UTC"</span><span style="color: #4f97d7;">)</span>
regions.xts <span style="color: #a45bad;">&lt;-</span> xts<span style="color: #4f97d7;">(</span>data.matrix<span style="color: #bc6ec5;">(</span>data.byPerimetre<span style="color: #2d9574;">[</span>, c<span style="color: #67b11d;">(</span>-<span style="color: #a45bad;">1</span>,-<span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>,order.by=dates<span style="color: #4f97d7;">)</span>

ep <span style="color: #a45bad;">&lt;-</span> endpoints<span style="color: #4f97d7;">(</span>regions.xts, <span style="color: #2d9574;">"minutes"</span>, k=<span style="color: #a45bad;">30</span><span style="color: #4f97d7;">)</span>
halfHour.xts <span style="color: #a45bad;">&lt;-</span> period.apply<span style="color: #4f97d7;">(</span>na.locf<span style="color: #bc6ec5;">(</span>regions.xts<span style="color: #bc6ec5;">)</span>, INDEX = ep, FUN = mean<span style="color: #4f97d7;">)</span>

plot.xts<span style="color: #4f97d7;">(</span>halfHour.xts<span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/r_xts.png" alt="r_xts.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-R"><span style="color: #bc6ec5; font-weight: bold;">tHourly</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span><span style="color: #4f97d7;">(</span>x<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">print(index(x[1]))</span>
  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">initialize result matrix for all 48 half-hour</span>
  dnames <span style="color: #a45bad;">&lt;-</span> list<span style="color: #bc6ec5;">(</span>paste0<span style="color: #2d9574;">(</span>date<span style="color: #67b11d;">(</span>index<span style="color: #b1951d;">(</span>x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>,
                 paste0<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"H"</span>, seq<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">23.5</span>,<span style="color: #a45bad;">0.5</span><span style="color: #67b11d;">)</span>, rep<span style="color: #67b11d;">(</span>colnames<span style="color: #b1951d;">(</span>x<span style="color: #b1951d;">)</span>, each = <span style="color: #a45bad;">48</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  res <span style="color: #a45bad;">&lt;-</span> matrix<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">NA</span>, <span style="color: #a45bad;">1</span>, dim<span style="color: #2d9574;">(</span>x<span style="color: #2d9574;">)[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span> * <span style="color: #a45bad;">48</span>, dimnames = dnames<span style="color: #bc6ec5;">)</span>
  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">update result object and return</span>
  res<span style="color: #bc6ec5;">[</span>,<span style="color: #bc6ec5;">]</span> <span style="color: #a45bad;">&lt;-</span> unlist<span style="color: #bc6ec5;">(</span>split<span style="color: #2d9574;">(</span>t<span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span>, seq<span style="color: #67b11d;">(</span>ncol<span style="color: #b1951d;">(</span>x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  res
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">split on days, apply tHourly to each day, rbind results</span>
p_mat <span style="color: #a45bad;">&lt;-</span> split<span style="color: #4f97d7;">(</span>halfHour.xts, f=<span style="color: #2d9574;">"days"</span>, drop=<span style="color: #ce537a; font-weight: bold;">FALSE</span>, k=<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
p_list <span style="color: #a45bad;">&lt;-</span> lapply<span style="color: #4f97d7;">(</span>p_mat, tHourly<span style="color: #4f97d7;">)</span>
p_hmat <span style="color: #a45bad;">&lt;-</span> do.call<span style="color: #4f97d7;">(</span>rbind, p_list<span style="color: #4f97d7;">)</span>

head<span style="color: #4f97d7;">(</span>p_hmat<span style="color: #bc6ec5;">[</span>,<span style="color: #a45bad;">1</span>:<span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">H0Auvergne-Rhône-Alpes</th>
<th scope="col" class="org-right">H0.5Auvergne-Rhône-Alpes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2013-01-02</td>
<td class="org-right">7847</td>
<td class="org-right">7674</td>
</tr>

<tr>
<td class="org-right">2013-01-03</td>
<td class="org-right">9028</td>
<td class="org-right">8839</td>
</tr>

<tr>
<td class="org-right">2013-01-04</td>
<td class="org-right">8982</td>
<td class="org-right">8754</td>
</tr>

<tr>
<td class="org-right">2013-01-05</td>
<td class="org-right">8625</td>
<td class="org-right">8465</td>
</tr>

<tr>
<td class="org-right">2013-01-06</td>
<td class="org-right">8314</td>
<td class="org-right">8097</td>
</tr>

<tr>
<td class="org-right">2013-01-07</td>
<td class="org-right">8312</td>
<td class="org-right">8214</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">dim<span style="color: #4f97d7;">(</span>p_hmat<span style="color: #4f97d7;">)</span>
sum<span style="color: #4f97d7;">(</span>is.na<span style="color: #bc6ec5;">(</span>p_hmat<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
[1] 1703  576
[1] 0
</p>
</div>
</div>
</div>


<div id="outline-container-orge89a232" class="outline-3">
<h3 id="orge89a232"><span class="section-number-3">1.2</span> Transform the data</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-orga1d2898" class="outline-4">
<h4 id="orga1d2898"><span class="section-number-4">1.2.1</span> Stationarity</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
As all the series are daily values there is a strong weekly seasonality within
the raw values. Looking at the decomposition of one of the series, we can also
clearly see the yearly seasonality.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>tidyverse<span style="color: #4f97d7;">)</span>
<span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>xts<span style="color: #4f97d7;">)</span>


consommation <span style="color: #a45bad;">&lt;-</span> read.csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'./data/consommation.csv'</span>, row.names=<span style="color: #2d9574;">'date'</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">consommation &lt;- xts(consommation, order.by = as.Date(as.POSIXct(parse_date(rownames(consommation)))))</span>

ts1 = ts<span style="color: #4f97d7;">(</span>consommation<span style="color: #bc6ec5;">[</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, frequency = <span style="color: #a45bad;">375</span>, start = <span style="color: #a45bad;">2013</span><span style="color: #4f97d7;">)</span>
plot<span style="color: #4f97d7;">(</span>decompose<span style="color: #bc6ec5;">(</span>ts1<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/decompose_R.png" alt="decompose_R.png" />
</p>
</div>

<p>
In order to transform the data to stationary series, we need to study the
 autocorrelation function. The black lines show the autocorrelation function until lag 100
 of each individual series, while the red one is the function of the mean of the
 series. That first autocorrelation clearly shows the weekly seasonality.
</p>

<div class="org-src-container">
<pre class="src src-R">plot<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>consommation<span style="color: #2d9574;">[</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, lag=<span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span>, type=<span style="color: #2d9574;">"l"</span>, max.mfrow=<span style="color: #a45bad;">1</span>, ylim=c<span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">0.4</span>, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">(</span>i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #a45bad;">2</span>:dim<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">){</span>
  lines<span style="color: #bc6ec5;">(</span>acf<span style="color: #2d9574;">(</span>consommation<span style="color: #67b11d;">[</span>,i<span style="color: #67b11d;">]</span>, lag=<span style="color: #a45bad;">100</span>, plot=<span style="color: #ce537a; font-weight: bold;">FALSE</span><span style="color: #2d9574;">)</span>$acf<span style="color: #2d9574;">[</span>-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, lty=<span style="color: #a45bad;">1</span>, lwd=<span style="color: #a45bad;">0.1</span>, alpha=<span style="color: #a45bad;">0.8</span><span style="color: #bc6ec5;">)</span>
<span style="color: #4f97d7;">}</span>
lines<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>rowMeans<span style="color: #2d9574;">(</span>consommation<span style="color: #2d9574;">)</span>, lag=<span style="color: #a45bad;">100</span>, plot=<span style="color: #ce537a; font-weight: bold;">FALSE</span><span style="color: #bc6ec5;">)</span>$acf<span style="color: #bc6ec5;">[</span>-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, lty=<span style="color: #a45bad;">1</span>, lwd=<span style="color: #a45bad;">2</span>, col=<span style="color: #2d9574;">'red'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/acf0_R.png" alt="acf0_R.png" />
</p>
</div>

<p>
To try and remove it, I have taken the weekly difference (difference between all
the values separated by 7 days). Now there is still some correlation, but it is better.
</p>

<div class="org-src-container">
<pre class="src src-R">consommation = diff<span style="color: #4f97d7;">(</span>as.matrix<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)</span>, <span style="color: #a45bad;">7</span><span style="color: #4f97d7;">)</span>
plot<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>consommation<span style="color: #2d9574;">[</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, lag=<span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span>, type=<span style="color: #2d9574;">"l"</span>, max.mfrow=<span style="color: #a45bad;">1</span>, ylim=c<span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">0.4</span>, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">(</span>i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #a45bad;">2</span>:dim<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">){</span>
  lines<span style="color: #bc6ec5;">(</span>acf<span style="color: #2d9574;">(</span>consommation<span style="color: #67b11d;">[</span>,i<span style="color: #67b11d;">]</span>, lag=<span style="color: #a45bad;">100</span>, plot=<span style="color: #ce537a; font-weight: bold;">FALSE</span><span style="color: #2d9574;">)</span>$acf<span style="color: #2d9574;">[</span>-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, lty=<span style="color: #a45bad;">1</span>, lwd=<span style="color: #a45bad;">0.1</span>, alpha=<span style="color: #a45bad;">0.8</span><span style="color: #bc6ec5;">)</span>
<span style="color: #4f97d7;">}</span>
lines<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>rowMeans<span style="color: #2d9574;">(</span>consommation<span style="color: #2d9574;">)</span>, lag=<span style="color: #a45bad;">100</span>, plot=<span style="color: #ce537a; font-weight: bold;">FALSE</span><span style="color: #bc6ec5;">)</span>$acf<span style="color: #bc6ec5;">[</span>-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, lty=<span style="color: #a45bad;">1</span>, lwd=<span style="color: #a45bad;">2</span>, col=<span style="color: #2d9574;">'red'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/acf1_R.png" alt="acf1_R.png" />
</p>
</div>

<p>
So as to get as close stationarity as possible without loosing too much data, I
have taken another difference, but this time only 1 day. Now, most of the values
stay within the confidence interval.
</p>

<div class="org-src-container">
<pre class="src src-R">consommation = diff<span style="color: #4f97d7;">(</span>consommation, <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
plot<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>consommation<span style="color: #2d9574;">[</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, lag=<span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span>, type=<span style="color: #2d9574;">"l"</span>, max.mfrow=<span style="color: #a45bad;">1</span>, ylim=c<span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">0.4</span>, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">(</span>i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #a45bad;">2</span>:dim<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">){</span>
  lines<span style="color: #bc6ec5;">(</span>acf<span style="color: #2d9574;">(</span>consommation<span style="color: #67b11d;">[</span>,i<span style="color: #67b11d;">]</span>, lag=<span style="color: #a45bad;">100</span>, plot=<span style="color: #ce537a; font-weight: bold;">FALSE</span><span style="color: #2d9574;">)</span>$acf<span style="color: #2d9574;">[</span>-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, lty=<span style="color: #a45bad;">1</span>, lwd=<span style="color: #a45bad;">0.1</span>, alpha=<span style="color: #a45bad;">0.8</span><span style="color: #bc6ec5;">)</span>
<span style="color: #4f97d7;">}</span>
lines<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>rowMeans<span style="color: #2d9574;">(</span>consommation<span style="color: #2d9574;">)</span>, lag=<span style="color: #a45bad;">100</span>, plot=<span style="color: #ce537a; font-weight: bold;">FALSE</span><span style="color: #bc6ec5;">)</span>$acf<span style="color: #bc6ec5;">[</span>-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, lty=<span style="color: #a45bad;">1</span>, lwd=<span style="color: #a45bad;">2</span>, col=<span style="color: #2d9574;">'red'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/acf17_R.png" alt="acf17_R.png" />
</p>
</div>

<p>
I have then used the Dickey-Fuller test on all the series and confirmed that
all the series are now significantly stationary (all p-values lower than 0.01).
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>fpp<span style="color: #4f97d7;">)</span>

max_p = <span style="color: #a45bad;">0</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">(</span>i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #a45bad;">2</span>:dim<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">){</span>
  p = adf.test<span style="color: #bc6ec5;">(</span>consommation<span style="color: #2d9574;">[</span>,i<span style="color: #2d9574;">]</span>, alternative=<span style="color: #2d9574;">'stationary'</span><span style="color: #bc6ec5;">)</span>$p.value
  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>p &gt; max_p<span style="color: #bc6ec5;">){</span>
    max_p <span style="color: #a45bad;">&lt;-</span> p
  <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
print<span style="color: #4f97d7;">(</span>paste<span style="color: #bc6ec5;">(</span>c<span style="color: #2d9574;">(</span><span style="color: #2d9574;">'All values below'</span>, max_p<span style="color: #2d9574;">)</span>, collapse=<span style="color: #2d9574;">' '</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
There were 50 or more warnings (use warnings() to see the first 50)
[1] "All values below 0.01"
</p>


<p>
In Python, I have done exactly the same thing and can see that we can the exact
same autocorrelation function.
</p>

<div class="org-src-container">
<pre class="src src-ipython"> <span style="color: #4f97d7; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #4f97d7; font-weight: bold;">import</span> acf
 <span style="color: #4f97d7; font-weight: bold;">import</span> pandas <span style="color: #4f97d7; font-weight: bold;">as</span> pd
 <span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #4f97d7; font-weight: bold;">as</span> plt
<span style="color: #4f97d7; font-weight: bold;">from</span> os.path <span style="color: #4f97d7; font-weight: bold;">import</span> join
 %matplotlib inline

<span style="color: #7590db;">data_path</span> = <span style="color: #2d9574;">"data"</span>

 <span style="color: #7590db;">consommation</span> = pd.read_csv<span style="color: #4f97d7;">(</span>join<span style="color: #bc6ec5;">(</span>data_path, <span style="color: #2d9574;">'consommation.csv'</span><span style="color: #bc6ec5;">)</span>, index_col=<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
 <span style="color: #7590db;">consommation</span> = consommation.diff<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">7</span><span style="color: #4f97d7;">)</span>.diff<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>.iloc<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">8</span>:,:<span style="color: #4f97d7;">]</span>

 plt.figure<span style="color: #4f97d7;">()</span>
 <span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
 <span style="color: #4f97d7; font-weight: bold;">for</span> columns <span style="color: #4f97d7; font-weight: bold;">in</span> consommation:
     plt.plot<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>consommation.loc<span style="color: #2d9574;">[</span>:,columns<span style="color: #2d9574;">]</span>, nlags=<span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">05</span>, color=<span style="color: #2d9574;">"black"</span><span style="color: #4f97d7;">)</span>
 plt.plot<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>consommation.mean<span style="color: #2d9574;">(</span>axis=<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>, nlags=<span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span>, color=<span style="color: #2d9574;">'red'</span><span style="color: #4f97d7;">)</span>
 ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Lag"</span><span style="color: #4f97d7;">)</span>
 ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Autocorrelation"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'Autocorrelation')

</pre>

<div class="figure">
<p><img src="./obipy-resources/17950Jd1.png" alt="17950Jd1.png" />
</p>
</div>


<p>
In Python is was possible to get the exact p-values and show that the largest
p-value is actually of order 10<sup>-22</sup>.
</p>

<div class="org-src-container">
<pre class="src src-ipython">  <span style="color: #4f97d7; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #4f97d7; font-weight: bold;">import</span> adfuller

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test_stationarity</span><span style="color: #4f97d7;">(</span>timeseries<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Perform Dickey-Fuller test:</span>
    <span style="color: #7590db;">dftest</span> = adfuller<span style="color: #4f97d7;">(</span>timeseries, autolag=<span style="color: #2d9574;">"AIC"</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">dfoutput</span> = pd.Series<span style="color: #4f97d7;">(</span>dftest<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>:<span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span>, index=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'Test Statistic'</span>, <span style="color: #2d9574;">'p-value'</span>, <span style="color: #2d9574;">'#Lags Used'</span>, <span style="color: #2d9574;">'Number of Observations Used'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> key, value <span style="color: #4f97d7; font-weight: bold;">in</span> dftest<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">]</span>.items<span style="color: #4f97d7;">()</span>:
        <span style="color: #7590db;">dfoutput</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'Critical Value (%s)'</span> % key<span style="color: #4f97d7;">]</span> = value
    <span style="color: #4f97d7; font-weight: bold;">return</span> dfoutput

<span style="color: #7590db;">p_values</span> = consommation.<span style="color: #4f97d7;">apply</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: test_stationarity<span style="color: #bc6ec5;">(</span>x<span style="color: #bc6ec5;">)[</span><span style="color: #2d9574;">"p-value"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
p_values.<span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
1.6017214722253976e-22

</pre>
</div>
</div>

<div id="outline-container-org1a0496a" class="outline-4">
<h4 id="org1a0496a"><span class="section-number-4">1.2.2</span> Data standardisation</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
In order to standardise the data and get a mean of 0 and standard deviation of
1, the z-score was applied to each individual series.
</p>

<p>
\[Z = \frac{x - \mu}{\sigma}\]
</p>

<div class="org-src-container">
<pre class="src src-R">consommation <span style="color: #a45bad;">&lt;-</span> scale<span style="color: #4f97d7;">(</span>consommation<span style="color: #4f97d7;">)</span>

print<span style="color: #4f97d7;">(</span>mean<span style="color: #bc6ec5;">(</span>consommation<span style="color: #2d9574;">[</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
print<span style="color: #4f97d7;">(</span>sd<span style="color: #bc6ec5;">(</span>consommation<span style="color: #2d9574;">[</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
[1] -1.414671e-17
[1] 1
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> scipy.stats.mstats <span style="color: #4f97d7; font-weight: bold;">import</span> zscore
<span style="color: #7590db;">consommation</span> = consommation.<span style="color: #4f97d7;">apply</span><span style="color: #4f97d7;">(</span>zscore, axis=<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Mean of z score is between'</span>, consommation.mean<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">min</span><span style="color: #bc6ec5;">()</span>, <span style="color: #2d9574;">' and '</span>, consommation.mean<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Std of z score is between'</span>, consommation.std<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">min</span><span style="color: #bc6ec5;">()</span>, <span style="color: #2d9574;">' and '</span>, consommation.std<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
Mean of z score is between -3.45623741149e-17  and  2.94650455584e-17
Std of z score is between 1.00028007282  and  1.00028007282
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orge097ce9" class="outline-2">
<h2 id="orge097ce9"><span class="section-number-2">2</span> Calculation of GCC</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgf290815" class="outline-3">
<h3 id="orgf290815"><span class="section-number-3">2.1</span> Selection of k</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org216dea9" class="outline-4">
<h4 id="org216dea9"><span class="section-number-4">2.1.1</span> PACF</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
At first I decided to check for the order of AR from our times series by
looking at the 'partial autocorrelation function', which is the autocorrelation
of the series but controlling for the correlations between values at shorter
lags.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #4f97d7; font-weight: bold;">import</span> pacf    
<span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np

plt.figure<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">all_pacf</span> = np.array<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>pacf<span style="color: #2d9574;">(</span>consommation.loc<span style="color: #67b11d;">[</span>:,columns<span style="color: #67b11d;">]</span>, nlags=<span style="color: #a45bad;">100</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> columns <span style="color: #4f97d7; font-weight: bold;">in</span> consommation<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">mean_pacf</span> = pacf<span style="color: #4f97d7;">(</span>consommation.mean<span style="color: #bc6ec5;">(</span>axis=<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>.values, nlags=<span style="color: #a45bad;">100</span><span style="color: #4f97d7;">)</span>
plt.axhline<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">96</span>/np.sqrt<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">len</span><span style="color: #2d9574;">(</span>mean_pacf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>, color=<span style="color: #2d9574;">'red'</span><span style="color: #4f97d7;">)</span>
plt.axhline<span style="color: #4f97d7;">(</span>-<span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">96</span>/np.sqrt<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">len</span><span style="color: #2d9574;">(</span>mean_pacf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>, color=<span style="color: #2d9574;">'red'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> p <span style="color: #4f97d7; font-weight: bold;">in</span> all_pacf:
    plt.plot<span style="color: #4f97d7;">(</span>p, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">05</span>, color=<span style="color: #2d9574;">"black"</span><span style="color: #4f97d7;">)</span>
plt.plot<span style="color: #4f97d7;">(</span>pacf<span style="color: #bc6ec5;">(</span>consommation.mean<span style="color: #2d9574;">(</span>axis=<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>, nlags=<span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span>, color=<span style="color: #2d9574;">'red'</span><span style="color: #4f97d7;">)</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Lag"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Partial Autocorrelation"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'Partial Autocorrelation')

</pre>

<div class="figure">
<p><img src="./img/pacf_python.png" alt="pacf_python.png" />
</p>
</div>

<p>
I then looked at those local minimums (for each 10 lag interval) by first getting the minimums of the mean
pacf (red line).
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">mean_pacf</span> = pacf<span style="color: #4f97d7;">(</span>consommation.mean<span style="color: #bc6ec5;">(</span>axis=<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>.values, nlags=<span style="color: #a45bad;">100</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">orders</span> = <span style="color: #4f97d7;">[</span>r<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> + mean_pacf<span style="color: #bc6ec5;">[</span>r<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span> : r<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">]</span>.argmin<span style="color: #bc6ec5;">()</span>
 <span style="color: #4f97d7; font-weight: bold;">for</span> r <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>np.arange<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">100</span>, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span>, np.arange<span style="color: #2d9574;">(</span><span style="color: #a45bad;">10</span>, <span style="color: #a45bad;">110</span>, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span>
orders
</pre>
</div>

<pre class="example">
[7, 14, 21, 35, 42, 56, 63, 70, 84, 98]

</pre>

<p>
And then I checked the minimum across all the series, so as to make sure that
the order was large enough for all series. The values are the same originally
but deviate at larger lag. It seems that 21 is the largest significant order.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">orders</span> = <span style="color: #4f97d7;">[</span>r<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> + np.where<span style="color: #bc6ec5;">(</span>all_pacf<span style="color: #2d9574;">[</span>:, r<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>:r<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span> == all_pacf<span style="color: #2d9574;">[</span>:, r<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>:r<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span>.<span style="color: #4f97d7;">min</span><span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">][</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> r <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>np.arange<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">100</span>, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span>, np.arange<span style="color: #2d9574;">(</span><span style="color: #a45bad;">10</span>, <span style="color: #a45bad;">110</span>, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span>
orders
</pre>
</div>

<pre class="example">
[7, 14, 21, 35, 42, 56, 63, 77, 84, 91]

</pre>
</div>
</div>

<div id="outline-container-org87cc9e2" class="outline-4">
<h4 id="org87cc9e2"><span class="section-number-4">2.1.2</span> AR model fitting</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
By fitting an AR model to each series with a maximum lag 40, python was able to
get a k value of 37.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> statsmodels.tsa.ar_model <span style="color: #4f97d7; font-weight: bold;">as</span> ar
<span style="color: #7590db;">k</span> = consommation.<span style="color: #4f97d7;">apply</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: ar.AR<span style="color: #bc6ec5;">(</span>x<span style="color: #bc6ec5;">)</span>.select_order<span style="color: #bc6ec5;">(</span>maxlag=<span style="color: #a45bad;">40</span>, ic=<span style="color: #2d9574;">"bic"</span>, trend=<span style="color: #2d9574;">"nc"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>.<span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">()</span>
k
</pre>
</div>

<pre class="example">
: 37

</pre>

<p>
However, in R, k is 17.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>FitAR<span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5; font-weight: bold;">getOrder</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span><span style="color: #4f97d7;">(</span>ts, order.max=<span style="color: #a45bad;">40</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  SelectModel<span style="color: #bc6ec5;">(</span>ts, ARModel = <span style="color: #2d9574;">'AR'</span>, Criterion = <span style="color: #2d9574;">'BIC'</span>, lag.max = <span style="color: #a45bad;">20</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>
<span style="color: #4f97d7;">}</span>

k <span style="color: #a45bad;">&lt;-</span> max<span style="color: #4f97d7;">(</span>apply<span style="color: #bc6ec5;">(</span>consommation, <span style="color: #a45bad;">2</span>, getOrder<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
print<span style="color: #4f97d7;">(</span>k<span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
[1] 17
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">k</span>=<span style="color: #a45bad;">17</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org4e37e4f" class="outline-3">
<h3 id="org4e37e4f"><span class="section-number-3">2.2</span> GCC</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">from</span> scipy.spatial.distance <span style="color: #4f97d7; font-weight: bold;">import</span> pdist
<span style="color: #4f97d7; font-weight: bold;">from</span> scipy.spatial.distance <span style="color: #4f97d7; font-weight: bold;">import</span> squareform
<span style="color: #4f97d7; font-weight: bold;">import</span> itertools
<span style="color: #4f97d7; font-weight: bold;">import</span> pickle


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">k_matrix</span><span style="color: #4f97d7;">(</span>ts, k<span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">T</span> = ts.shape<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> np.array<span style="color: #4f97d7;">(</span>
        <span style="color: #bc6ec5;">[</span>ts<span style="color: #2d9574;">[</span><span style="color: #67b11d;">(</span>shift<span style="color: #67b11d;">)</span>:T - k + shift<span style="color: #2d9574;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> shift <span style="color: #4f97d7; font-weight: bold;">in</span> np.arange<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, k + <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">get_GCC</span><span style="color: #4f97d7;">(</span>ts1, ts2<span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">k</span> = <span style="color: #a45bad;">17</span>
    <span style="color: #7590db;">Xi</span> = k_matrix<span style="color: #4f97d7;">(</span>ts1, k<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">Xj</span> = k_matrix<span style="color: #4f97d7;">(</span>ts2, k<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">Xij</span> = np.concatenate<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>Xi, Xj<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">GCC</span> = np.linalg.det<span style="color: #4f97d7;">(</span>np.corrcoef<span style="color: #bc6ec5;">(</span>Xij<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> ** <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span> / <span style="color: #bc6ec5;">(</span>k + <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> / <span style="color: #4f97d7;">(</span>
        np.linalg.det<span style="color: #bc6ec5;">(</span>np.corrcoef<span style="color: #2d9574;">(</span>Xi<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> ** <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span> / <span style="color: #2d9574;">(</span>k + <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> \
        * np.linalg.det<span style="color: #bc6ec5;">(</span>np.corrcoef<span style="color: #2d9574;">(</span>Xj<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> ** <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span> / <span style="color: #2d9574;">(</span>k + <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> GCC


<span style="color: #7590db;">pdist_gcc</span> = pdist<span style="color: #4f97d7;">(</span>consommation.values.T, get_GCC<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">DM_GCC</span> = squareform<span style="color: #4f97d7;">(</span>pdist_gcc<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">DM_GCC</span> = pd.DataFrame<span style="color: #4f97d7;">(</span>
    DM_GCC, index=consommation.columns, columns=consommation.columns<span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> scipy.cluster.hierarchy <span style="color: #4f97d7; font-weight: bold;">as</span> hcl
<span style="color: #4f97d7; font-weight: bold;">from</span> scipy.spatial.distance <span style="color: #4f97d7; font-weight: bold;">import</span> pdist

<span style="color: #7590db;">linkage_gcc</span> = hcl.single<span style="color: #4f97d7;">(</span>pdist_gcc<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>hcl.cophenet<span style="color: #bc6ec5;">(</span>linkage_gcc, pdist_gcc<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">linkage_gcc</span> = hcl.ward<span style="color: #4f97d7;">(</span>pdist_gcc<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>hcl.cophenet<span style="color: #bc6ec5;">(</span>linkage_gcc, pdist_gcc<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">pdist_euc</span> = pdist<span style="color: #4f97d7;">(</span>consommation.values.T<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">linkage_euc</span> = hcl.ward<span style="color: #4f97d7;">(</span>pdist_euc<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span> <span style="color: #4f97d7;">(</span>hcl.cophenet<span style="color: #bc6ec5;">(</span>linkage_euc, pdist_euc<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">690518705818</span>
<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">665986421017</span>
<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">725037291315</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.metrics <span style="color: #4f97d7; font-weight: bold;">import</span> silhouette_score, silhouette_samples
<span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.cm <span style="color: #4f97d7; font-weight: bold;">as</span> cm

<span style="color: #7590db;">linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'single'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=<span style="color: #a45bad;">7</span>, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>

silhouette_score<span style="color: #4f97d7;">(</span>DM_GCC, clusters, metric=<span style="color: #2d9574;">'precomputed'</span><span style="color: #4f97d7;">)</span>



<span style="color: #4f97d7; font-weight: bold;">for</span> n_clusters <span style="color: #4f97d7; font-weight: bold;">in</span> np.arange<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span>,<span style="color: #a45bad;">20</span>,<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">cluster_labels</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">silhouette_avg</span> = silhouette_score<span style="color: #4f97d7;">(</span>DM_GCC, cluster_labels, metric=<span style="color: #2d9574;">'precomputed'</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"For n_clusters ="</span>, n_clusters,
          <span style="color: #2d9574;">"The average silhouette_score is :"</span>, silhouette_avg<span style="color: #4f97d7;">)</span>




</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Compute the silhouette scores for each sample</span>

<span style="color: #7590db;">n_clusters</span> = <span style="color: #a45bad;">7</span>
<span style="color: #7590db;">cluster_labels</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">sample_silhouette_values</span> = silhouette_samples<span style="color: #4f97d7;">(</span>DM_GCC, cluster_labels, metric=<span style="color: #2d9574;">'precomputed'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">silhouette_avg</span> = silhouette_score<span style="color: #4f97d7;">(</span>DM_GCC, cluster_labels, metric=<span style="color: #2d9574;">'precomputed'</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">y_lower</span> = <span style="color: #a45bad;">10</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>n_clusters<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Aggregate the silhouette scores for samples belonging to</span>
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">cluster i, and sort them</span>
    <span style="color: #7590db;">ith_cluster_silhouette_values</span> = \
        sample_silhouette_values<span style="color: #4f97d7;">[</span>cluster_labels == i<span style="color: #4f97d7;">]</span>

    ith_cluster_silhouette_values.sort<span style="color: #4f97d7;">()</span>

    <span style="color: #7590db;">size_cluster_i</span> = ith_cluster_silhouette_values.shape<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>
    <span style="color: #7590db;">y_upper</span> = y_lower + size_cluster_i

    <span style="color: #7590db;">color</span> = cm.spectral<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">float</span><span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> / n_clusters<span style="color: #4f97d7;">)</span>
    plt.fill_betweenx<span style="color: #4f97d7;">(</span>np.arange<span style="color: #bc6ec5;">(</span>y_lower, y_upper<span style="color: #bc6ec5;">)</span>,
                      <span style="color: #a45bad;">0</span>, ith_cluster_silhouette_values,
                      facecolor=color, edgecolor=color, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">7</span><span style="color: #4f97d7;">)</span>

    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Label the silhouette plots with their cluster numbers at the middle</span>
    plt.text<span style="color: #4f97d7;">(</span>-<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">05</span>, y_lower + <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span> * size_cluster_i, <span style="color: #4f97d7;">str</span><span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Compute the new y_lower for next plot</span>
    <span style="color: #7590db;">y_lower</span> = y_upper + <span style="color: #a45bad;">10</span>  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">10 for the 0 samples</span>
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">The vertical line for average silhouette score of all the values</span>
    plt.axvline<span style="color: #4f97d7;">(</span>x=silhouette_avg, color=<span style="color: #2d9574;">"red"</span>, linestyle=<span style="color: #2d9574;">"--"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/17950aOc.png" alt="17950aOc.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-R"><span style="color: #bc6ec5; font-weight: bold;">kMatrix</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span><span style="color: #4f97d7;">(</span>ts, k<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  m <span style="color: #a45bad;">&lt;-</span> ts<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> : <span style="color: #2d9574;">(</span>length<span style="color: #67b11d;">(</span>ts<span style="color: #67b11d;">)</span> - k<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span>
  <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i <span style="color: #4f97d7; font-weight: bold;">in</span> seq<span style="color: #2d9574;">(</span>k<span style="color: #2d9574;">)[</span><span style="color: #a45bad;">2</span>:k<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    m <span style="color: #a45bad;">&lt;-</span> cbind<span style="color: #2d9574;">(</span>m, ts<span style="color: #67b11d;">[</span>i : <span style="color: #b1951d;">(</span>length<span style="color: #4f97d7;">(</span>ts<span style="color: #4f97d7;">)</span> - k + i - <span style="color: #a45bad;">1</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>
  <span style="color: #bc6ec5;">}</span>
  m
<span style="color: #4f97d7;">}</span>

<span style="color: #bc6ec5; font-weight: bold;">GCC</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span><span style="color: #4f97d7;">(</span>ts1, ts2, k<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  Xi <span style="color: #a45bad;">&lt;-</span>  kMatrix<span style="color: #bc6ec5;">(</span>ts1, k<span style="color: #bc6ec5;">)</span>
  Xj <span style="color: #a45bad;">&lt;-</span>  kMatrix<span style="color: #bc6ec5;">(</span>ts2, k<span style="color: #bc6ec5;">)</span>

  Xij <span style="color: #a45bad;">&lt;-</span> cbind<span style="color: #bc6ec5;">(</span>Xi, Xj<span style="color: #bc6ec5;">)</span>

  <span style="color: #a45bad;">1</span> - det<span style="color: #bc6ec5;">(</span>cor<span style="color: #2d9574;">(</span>Xij<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>^<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>/<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span>*<span style="color: #67b11d;">(</span>k+<span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> /
    <span style="color: #bc6ec5;">(</span>det<span style="color: #2d9574;">(</span>cor<span style="color: #67b11d;">(</span>Xi<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>^<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span>/<span style="color: #67b11d;">(</span><span style="color: #a45bad;">2</span>*<span style="color: #b1951d;">(</span>k+<span style="color: #a45bad;">1</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> * det<span style="color: #2d9574;">(</span>cor<span style="color: #67b11d;">(</span>Xj<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>^<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span>/<span style="color: #67b11d;">(</span><span style="color: #a45bad;">2</span>*<span style="color: #b1951d;">(</span>k+<span style="color: #a45bad;">1</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
<span style="color: #4f97d7;">}</span>

combinations <span style="color: #a45bad;">&lt;-</span> combn<span style="color: #4f97d7;">(</span>dim<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
DM_GCC <span style="color: #a45bad;">&lt;-</span> matrix<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>, dim<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>, dim<span style="color: #bc6ec5;">(</span>consommation<span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">(</span>d <span style="color: #4f97d7; font-weight: bold;">in</span> seq<span style="color: #bc6ec5;">(</span>dim<span style="color: #2d9574;">(</span>combinations<span style="color: #2d9574;">)[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  distance <span style="color: #a45bad;">&lt;-</span> GCC<span style="color: #bc6ec5;">(</span>consommation<span style="color: #2d9574;">[</span>, combinations<span style="color: #67b11d;">[</span>,d<span style="color: #67b11d;">][</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span>,
                  consommation<span style="color: #2d9574;">[</span>, combinations<span style="color: #67b11d;">[</span>,d<span style="color: #67b11d;">][</span><span style="color: #a45bad;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span>, k<span style="color: #bc6ec5;">)</span>
  DM_GCC<span style="color: #bc6ec5;">[</span>combinations<span style="color: #2d9574;">[</span>,d<span style="color: #2d9574;">][</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, combinations<span style="color: #2d9574;">[</span>,d<span style="color: #2d9574;">][</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">]</span> <span style="color: #a45bad;">&lt;-</span> distance
  DM_GCC<span style="color: #bc6ec5;">[</span>combinations<span style="color: #2d9574;">[</span>,d<span style="color: #2d9574;">][</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span>, combinations<span style="color: #2d9574;">[</span>,d<span style="color: #2d9574;">][</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">]</span> <span style="color: #a45bad;">&lt;-</span> distance
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1cf9966" class="outline-2">
<h2 id="org1cf9966"><span class="section-number-2">3</span> Clustering</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> inspect

<span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #4f97d7; font-weight: bold;">import</span> pacf    
<span style="color: #4f97d7; font-weight: bold;">import</span> statsmodels.tsa.api <span style="color: #4f97d7; font-weight: bold;">as</span> smt

<span style="color: #4f97d7; font-weight: bold;">import</span> src.helpers <span style="color: #4f97d7; font-weight: bold;">as</span> helpers
</pre>
</div>
</div>

<div id="outline-container-orgedf2dc8" class="outline-3">
<h3 id="orgedf2dc8"><span class="section-number-3">3.1</span> Determination of the number of clusters</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> scipy.cluster.hierarchy <span style="color: #4f97d7; font-weight: bold;">as</span> hcl
<span style="color: #4f97d7; font-weight: bold;">from</span> scipy.spatial.distance <span style="color: #4f97d7; font-weight: bold;">import</span> squareform
<span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np

<span style="color: #7590db;">linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'single'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
# Out[512]:

</pre>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> scipy.cluster.hierarchy <span style="color: #4f97d7; font-weight: bold;">import</span> dendrogram

<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>

dendrogram<span style="color: #4f97d7;">(</span>linkage,
           labels = labels<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"nipy_spectral"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>

<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.show<span style="color: #4f97d7;">()</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/17950lIs.png" alt="17950lIs.png" />
</p>
</div>



<div class="org-src-container">
<pre class="src src-ipython">plt.figure<span style="color: #4f97d7;">()</span>
plt.plot<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">range</span><span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>, <span style="color: #4f97d7;">len</span><span style="color: #2d9574;">(</span>linkage<span style="color: #2d9574;">)</span>+<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>, linkage<span style="color: #bc6ec5;">[</span>::-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlim<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">50</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
ax.set_ylim<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">400</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Number of clusters"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Between clusters distance"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'Between clusters distance')

</pre>

<div class="figure">
<p><img src="./img/elbow.png" alt="elbow.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">elbow</span> = np.diff<span style="color: #4f97d7;">(</span>linkage<span style="color: #bc6ec5;">[</span>::-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">n_clust1</span> = elbow.argmax<span style="color: #4f97d7;">()</span>+<span style="color: #a45bad;">2</span>
<span style="color: #7590db;">elbow</span><span style="color: #4f97d7;">[</span>elbow.argmax<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">0</span>
<span style="color: #7590db;">n_clust2</span> = elbow.argmax<span style="color: #4f97d7;">()</span>+<span style="color: #a45bad;">2</span>
<span style="color: #4f97d7;">[</span>n_clust1, n_clust2<span style="color: #4f97d7;">]</span>
</pre>
</div>

<pre class="example">
[2, 5]

</pre>
</div>
</div>

<div id="outline-container-org847f219" class="outline-3">
<h3 id="org847f219"><span class="section-number-3">3.2</span> Clustering methods comparison</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">n_clusters</span> = <span style="color: #a45bad;">7</span>
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">tsne_2dim</span> = TSNE<span style="color: #4f97d7;">(</span>n_components=<span style="color: #a45bad;">2</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_transform<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust1_TSNE.png" alt="n_clust1_TSNE.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.decomposition <span style="color: #4f97d7; font-weight: bold;">import</span> PCA

<span style="color: #7590db;">n_clusters</span> = <span style="color: #a45bad;">7</span>
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">pca_2dim</span> = PCA<span style="color: #4f97d7;">(</span>n_components=<span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>.fit_transform<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>pca_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, pca_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"1st component"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"2nd component"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'2nd component')

</pre>

<div class="figure">
<p><img src="./obipy-resources/179500io.png" alt="179500io.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">n_clusters</span> = <span style="color: #a45bad;">7</span>
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">tsne_2dim</span> = TSNE<span style="color: #4f97d7;">(</span>n_components=<span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>.fit_transform<span style="color: #4f97d7;">(</span>consommation.T<span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./obipy-resources/17950nYi.png" alt="17950nYi.png" />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org5844edb" class="outline-2">
<h2 id="org5844edb"><span class="section-number-2">4</span> Plot Clusters</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">n_clusters</span> = <span style="color: #a45bad;">7</span>
<span style="color: #7590db;">linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'single'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=<span style="color: #a45bad;">12</span>, criterion=<span style="color: #2d9574;">"maxclust_monocrit"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org33b8958" class="outline-3">
<h3 id="org33b8958"><span class="section-number-3">4.1</span> Mapping the clusters</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">regions</span> = <span style="color: #4f97d7;">[</span>string.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> string <span style="color: #4f97d7; font-weight: bold;">in</span> consommation.columns<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">times</span> = <span style="color: #4f97d7;">[</span>string.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> string <span style="color: #4f97d7; font-weight: bold;">in</span> consommation.columns<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">consommation_clusters</span> = pd.DataFrame<span style="color: #4f97d7;">(</span>np.transpose<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>regions,
                                                times,
                                                <span style="color: #4f97d7;">list</span><span style="color: #67b11d;">(</span>clusters<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>, columns=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Region"</span>, <span style="color: #2d9574;">"Time"</span>, <span style="color: #2d9574;">"Cluster"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
# Out[524]:

</pre>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">region_cluster</span> = consommation_clusters.groupby<span style="color: #4f97d7;">(</span>by=<span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">)[</span><span style="color: #2d9574;">"Cluster"</span><span style="color: #4f97d7;">]</span>.value_counts<span style="color: #4f97d7;">()</span>.index.to_frame<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">region_cluster.index</span> = region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">]</span>.values

<span style="color: #7590db;">region_codes</span> = pd.read_csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"./data/frenchRegions.csv"</span><span style="color: #4f97d7;">)</span>

region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">]</span>.isin<span style="color: #4f97d7;">(</span>region_codes<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">region_cluster</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"region_match"</span><span style="color: #4f97d7;">]</span> = region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">region_codes</span> = <span style="color: #4f97d7;">{}</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Auvergne-Rh&#244;ne-Alpes"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">83</span>, <span style="color: #a45bad;">82</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Bourgogne-Franche-Comt&#233;"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">26</span>, <span style="color: #a45bad;">43</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Bretagne"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">53</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Centre-Val de Loire"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">24</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Grand-Est"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">42</span>, <span style="color: #a45bad;">21</span>, <span style="color: #a45bad;">41</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Hauts-de-France"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">31</span>, <span style="color: #a45bad;">22</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Ile-de-France"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">11</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Normandie"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">23</span>, <span style="color: #a45bad;">25</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Nouvelle-Aquitaine"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">72</span>, <span style="color: #a45bad;">54</span>, <span style="color: #a45bad;">74</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Occitanie"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">91</span>, <span style="color: #a45bad;">73</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"PACA"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">93</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Pays-de-la-Loire"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">52</span><span style="color: #4f97d7;">]</span>
</pre>
</div>

<pre class="example">
# Out[525]:

</pre>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> pygal
<span style="color: #4f97d7; font-weight: bold;">from</span> itertools <span style="color: #4f97d7; font-weight: bold;">import</span> chain

<span style="color: #7590db;">fr_chart</span> = pygal.maps.fr.Regions<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">fr_chart.title</span> = <span style="color: #2d9574;">'Regions clusters'</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> cluster <span style="color: #4f97d7; font-weight: bold;">in</span> np.unique<span style="color: #4f97d7;">(</span>region_cluster<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Cluster"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>:
    fr_chart.add<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Cluster "</span> + <span style="color: #4f97d7;">str</span><span style="color: #bc6ec5;">(</span>cluster<span style="color: #bc6ec5;">)</span>, 
                 <span style="color: #4f97d7;">list</span><span style="color: #bc6ec5;">(</span>chain.from_iterable<span style="color: #2d9574;">(</span><span style="color: #67b11d;">[</span>region_codes<span style="color: #b1951d;">[</span>region<span style="color: #b1951d;">]</span> 
                                           <span style="color: #4f97d7; font-weight: bold;">for</span> region <span style="color: #4f97d7; font-weight: bold;">in</span> region_cluster.loc<span style="color: #b1951d;">[</span>
                                               region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Cluster"</span><span style="color: #4f97d7;">]</span>==cluster, <span style="color: #2d9574;">"Region"</span><span style="color: #b1951d;">]</span>.values<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
fr_chart.render_to_file<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"./img/regions_clusters.svg"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-org3bd5ab7" class="outline-3">
<h3 id="org3bd5ab7"><span class="section-number-3">4.2</span> Check within regions clusters</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">n_clusters</span> = <span style="color: #a45bad;">7</span>
<span style="color: #7590db;">linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'single'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=<span style="color: #a45bad;">7</span>, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython">plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">211</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"nipy_spectral"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">212</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"RdGy"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.show<span style="color: #4f97d7;">()</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/17950_qg.png" alt="17950_qg.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">sub_DM_GCC</span> = DM_GCC.loc<span style="color: #4f97d7;">[</span>clusters==<span style="color: #a45bad;">1</span>, clusters==<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">sub_linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>sub_DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'ward'</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">211</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"nipy_spectral"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">212</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"RdGy"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.show<span style="color: #4f97d7;">()</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/179507fQ.png" alt="179507fQ.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">sub_DM_GCC</span> = DM_GCC.loc<span style="color: #4f97d7;">[</span>clusters==<span style="color: #a45bad;">2</span>, clusters==<span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">sub_linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>sub_DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'ward'</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">211</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"nipy_spectral"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">212</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"RdGy"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.show<span style="color: #4f97d7;">()</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/17950IqW.png" alt="17950IqW.png" />
</p>
</div>




<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">sub_DM_GCC</span> = DM_GCC.loc<span style="color: #4f97d7;">[</span>clusters==<span style="color: #a45bad;">3</span>, clusters==<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">sub_linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>sub_DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'ward'</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">211</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"nipy_spectral"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">212</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"RdGy"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.show<span style="color: #4f97d7;">()</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/17950V0c.png" alt="17950V0c.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">sub_DM_GCC</span> = DM_GCC.loc<span style="color: #4f97d7;">[</span>clusters==<span style="color: #a45bad;">4</span>, clusters==<span style="color: #a45bad;">4</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">sub_linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>sub_DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">'ward'</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">211</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"nipy_spectral"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.subplot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">212</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">labels</span> = <span style="color: #4f97d7;">[</span>label.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'_'</span><span style="color: #bc6ec5;">)[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> label <span style="color: #4f97d7; font-weight: bold;">in</span> sub_DM_GCC.columns.values<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">unique_labels</span> = np.unique<span style="color: #4f97d7;">(</span>labels<span style="color: #4f97d7;">)</span>
dendrogram<span style="color: #4f97d7;">(</span>sub_linkage,
            labels = labels<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">my_palette</span> = plt.cm.get_cmap<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"RdGy"</span>, <span style="color: #4f97d7;">len</span><span style="color: #bc6ec5;">(</span>unique_labels<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">label_color</span> = <span style="color: #4f97d7;">{</span>l:my_palette<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> l, i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>unique_labels, np.arange<span style="color: #2d9574;">(</span><span style="color: #4f97d7;">len</span><span style="color: #67b11d;">(</span>unique_labels<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">xlbls</span> = ax.get_xmajorticklabels<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> lbl <span style="color: #4f97d7; font-weight: bold;">in</span> xlbls:
    lbl.set_color<span style="color: #4f97d7;">(</span>label_color<span style="color: #bc6ec5;">[</span>lbl.get_text<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.show<span style="color: #4f97d7;">()</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/17950i-i.png" alt="17950i-i.png" />
</p>
</div>


<div class="figure">
<p><img src="./obipy-resources/17950vB1.png" alt="17950vB1.png" />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org2c3d61b" class="outline-2">
<h2 id="org2c3d61b"><span class="section-number-2">5</span> References:</h2>
<div class="outline-text-2" id="text-5">
<p>
Ando, T. and Bai, J. (2016) Clustering huge number of financial time series: A panel data approach with high-dimensional predictors and factor structures. To appear at JASA. Available at: <a href="http://dx.doi.org/10.1080/01621459.2016.1195743">http://dx.doi.org/10.1080/01621459.2016.1195743</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Pierre Mercatoris</p>
<p class="date">Created: 2018-03-11 Sun 19:49</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
