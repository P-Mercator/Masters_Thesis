<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-01-12 Fri 23:16 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Clustering large number of time series.</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Pierre Mercatoris" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/bigblow.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Clustering large number of time series.</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org53ee757">1. Preparing the data</a>
<ul>
<li><a href="#org95f22d2">1.1. Reading the data</a>
<ul>
<li><a href="#org72fe0cd">1.1.1. In Python</a></li>
<li><a href="#org1ea7564">1.1.2. In R (NOT USED ANYMORE!)</a></li>
</ul>
</li>
<li><a href="#org6a6796d">1.2. Transform the data</a>
<ul>
<li><a href="#orgd2af660">1.2.1. In Python</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5bc4ccd">2. Calculation of GCC</a></li>
<li><a href="#orga50a1a5">3. Clustering</a>
<ul>
<li><a href="#orgad6ddd3">3.1. Determination of the number of clusters</a></li>
<li><a href="#org4f1cdc9">3.2. Clustering methods comparison</a></li>
</ul>
</li>
<li><a href="#org84b489d">4. Mapping the clusters</a></li>
<li><a href="#org7ce8824">5. Check within regions clusters</a></li>
<li><a href="#org881f6a1">6. References:</a></li>
</ul>
</div>
</div>


<div id="outline-container-org53ee757" class="outline-2">
<h2 id="org53ee757"><span class="section-number-2">1</span> Preparing the data</h2>
<div class="outline-text-2" id="text-1">
</div>

<div id="outline-container-org95f22d2" class="outline-3">
<h3 id="org95f22d2"><span class="section-number-3">1.1</span> Reading the data</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org72fe0cd" class="outline-4">
<h4 id="org72fe0cd"><span class="section-number-4">1.1.1</span> In Python</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
I have downloaded all the regions' annual data from 2013 to 2015, the
consolidated 2016 data as well as the running 2017 data. The data came split
between files for each 12 regions of France and each year, where each record
contains the date, the time, the region and the electricity consumption.
</p>

<p>
I have needed to correct the names of the regions as those where changed
(probably by error) on the 29th of February 2016. 
</p>
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> os.path <span style="color: #4f97d7; font-weight: bold;">import</span> join
<span style="color: #4f97d7; font-weight: bold;">import</span> glob
<span style="color: #4f97d7; font-weight: bold;">import</span> pandas <span style="color: #4f97d7; font-weight: bold;">as</span> pd

<span style="color: #7590db;">data_path</span> = <span style="color: #2d9574;">"data"</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Combine all the .xls of each region</span>
<span style="color: #7590db;">data</span> = pd.concat<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>
    pd.read_table<span style="color: #2d9574;">(</span>
        <span style="color: #4f97d7;">file</span>, encoding=<span style="color: #2d9574;">"cp1252"</span>, delimiter=<span style="color: #2d9574;">"\t"</span>, engine=<span style="color: #2d9574;">"python"</span>,
        index_col=<span style="color: #a45bad;">False</span><span style="color: #2d9574;">)</span>.iloc<span style="color: #2d9574;">[</span>:-<span style="color: #a45bad;">1</span>, :<span style="color: #2d9574;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">file</span> <span style="color: #4f97d7; font-weight: bold;">in</span> glob.glob<span style="color: #2d9574;">(</span>join<span style="color: #67b11d;">(</span>data_path, <span style="color: #2d9574;">"*.xls"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Format type of variables</span>
<span style="color: #7590db;">data</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Consommation"</span><span style="color: #4f97d7;">]</span> = pd.to_numeric<span style="color: #4f97d7;">(</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Consommation"</span><span style="color: #bc6ec5;">]</span>, errors=<span style="color: #2d9574;">'coerce'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">data</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Datetime"</span><span style="color: #4f97d7;">]</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>
    <span style="color: #bc6ec5;">(</span>data<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"Date"</span><span style="color: #2d9574;">]</span> + <span style="color: #2d9574;">'_'</span> + data<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"Heures"</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>.<span style="color: #4f97d7;">apply</span><span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">str</span><span style="color: #bc6ec5;">)</span>, <span style="color: #4f97d7;">format</span>=<span style="color: #2d9574;">'%Y-%m-%d_%H:%M'</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Correct regions names</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Auvergne et Rh&#244;ne-Alpes'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Auvergne-Rh&#244;ne-Alpes'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Bourgogne et Franche Comt&#233;'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Bourgogne-Franche-Comt&#233;'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Alsace, Champagne-Ardenne et Lorraine'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Grand-Est'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Nord-Pas-de-Calais et Picardie'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Hauts-de-France'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Aquitaine, Limousin et Poitou-Charentes'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Nouvelle-Aquitaine'</span>
data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> == <span style="color: #2d9574;">'Languedoc-Roussillon et Midi-Pyr&#233;n&#233;es'</span>, <span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #4f97d7;">]</span> = <span style="color: #2d9574;">'Occitanie'</span>
<span style="color: #7590db;">data</span> = data.loc<span style="color: #4f97d7;">[</span>data<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span> != <span style="color: #2d9574;">'France'</span>, :<span style="color: #4f97d7;">]</span>

data.head<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
Bioénergies Bioénergies - Biogaz Bioénergies - Biomasse  \
0          39                  NaN                    NaN
1         NaN                  NaN                    NaN
2          39                  NaN                    NaN
3         NaN                  NaN                    NaN
4          40                  NaN                    NaN

Bioénergies - Déchets  Charbon  Consommation        Date  \
0                   NaN      NaN        3296.0  2016-01-01
1                   NaN      NaN           NaN  2016-01-01
2                   NaN      NaN        3180.0  2016-01-01
3                   NaN      NaN           NaN  2016-01-01
4                   NaN      NaN        2969.0  2016-01-01

Ech. comm. Allemagne-Belgique Ech. comm. Angleterre Ech. comm. Espagne  \
0                           NaN                   NaN                NaN
1                           NaN                   NaN                NaN
2                           NaN                   NaN                NaN
3                           NaN                   NaN                NaN
4                           NaN                   NaN                NaN

...                       Nature Nucléaire Pompage Prévision J  \
0         ...          Données consolidées         -     -50         NaN
1         ...          Données consolidées       NaN     NaN         NaN
2         ...          Données consolidées         -     -53         NaN
3         ...          Données consolidées       NaN     NaN         NaN
4         ...          Données consolidées         -     -54         NaN

Prévision J-1 Périmètre Solaire Taux de Co2  Thermique            Datetime
0            NaN  Bretagne       0         NaN        140 2016-01-01 00:00:00
1            NaN  Bretagne     NaN         NaN        NaN 2016-01-01 00:15:00
2            NaN  Bretagne       0         NaN        141 2016-01-01 00:30:00
3            NaN  Bretagne     NaN         NaN        NaN 2016-01-01 00:45:00
4            NaN  Bretagne       0         NaN        140 2016-01-01 01:00:00

[5 rows x 38 columns]
</pre>

<p>
As all the regions are in the same columns, I have used a pivot table to get 1
column per region for each 'Datetime' (1 column for each of 12 regions). Additionally, it is important to set the timezone to UTC in order to account for
daylight saving time change so as to avoid removing data or introduce NA.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Reshape to row = datetime and column = region, all values are consumption</span>
<span style="color: #7590db;">consommation</span> = pd.pivot_table<span style="color: #4f97d7;">(</span>
    data, values=<span style="color: #2d9574;">'Consommation'</span>, index=<span style="color: #2d9574;">'Datetime'</span>, columns=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'P&#233;rim&#232;tre'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Set timezone as it creates problem when changing between daylight saving times.</span>
<span style="color: #7590db;">consommation</span> = consommation.tz_localize<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'UTC'</span>, ambiguous=<span style="color: #a45bad;">False</span><span style="color: #4f97d7;">)</span>

consommation.head<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
Périmètre                  Auvergne-Rhône-Alpes  Bourgogne-Franche-Comté  \
Datetime
2013-01-01 00:00:00+00:00                   NaN                      NaN
2013-01-01 00:15:00+00:00                   NaN                      NaN
2013-01-01 00:30:00+00:00                8173.0                   2357.0
2013-01-01 00:45:00+00:00                   NaN                      NaN
2013-01-01 01:00:00+00:00                7944.0                   2289.0

Périmètre                  Bretagne  Centre-Val de Loire  Grand-Est  \
Datetime
2013-01-01 00:00:00+00:00       NaN                  NaN        NaN
2013-01-01 00:15:00+00:00       NaN                  NaN        NaN
2013-01-01 00:30:00+00:00    3050.0               2476.0     4943.0
2013-01-01 00:45:00+00:00       NaN                  NaN        NaN
2013-01-01 01:00:00+00:00    2866.0               2319.0     4811.0

Périmètre                  Hauts-de-France  Ile-de-France  Normandie  \
Datetime
2013-01-01 00:00:00+00:00              NaN            NaN        NaN
2013-01-01 00:15:00+00:00              NaN            NaN        NaN
2013-01-01 00:30:00+00:00           5989.0         9134.0     3683.0
2013-01-01 00:45:00+00:00              NaN            NaN        NaN
2013-01-01 01:00:00+00:00           5832.0         8822.0     3549.0

Périmètre                  Nouvelle-Aquitaine  Occitanie    PACA  \
Datetime
2013-01-01 00:00:00+00:00                 NaN        NaN     NaN
2013-01-01 00:15:00+00:00                 NaN        NaN     NaN
2013-01-01 00:30:00+00:00              5464.0     5228.0  5570.0
2013-01-01 00:45:00+00:00                 NaN        NaN     NaN
2013-01-01 01:00:00+00:00              5422.0     4955.0  5698.0

Périmètre                  Pays-de-la-Loire
Datetime
2013-01-01 00:00:00+00:00               NaN
2013-01-01 00:15:00+00:00               NaN
2013-01-01 00:30:00+00:00            3595.0
2013-01-01 00:45:00+00:00               NaN
2013-01-01 01:00:00+00:00            3359.0
</pre>

<p>
Here are the resulting time series for each of the 12 regions. We can see some
outliers at the beginning of September 2017 where the data is close to 0. Those
gaps are expected as this data was not yet consolidated.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #4f97d7; font-weight: bold;">as</span> plt
%matplotlib inline

<span style="color: #7590db;">fig</span>, <span style="color: #7590db;">ax</span> = plt.subplots<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span>, <span style="color: #a45bad;">3</span>, sharex=<span style="color: #a45bad;">True</span>, sharey=<span style="color: #a45bad;">True</span><span style="color: #4f97d7;">)</span>
fig.set_size_inches<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">18</span>,<span style="color: #a45bad;">13</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>
<span style="color: #7590db;">row</span> = <span style="color: #a45bad;">0</span>
<span style="color: #7590db;">cons</span> = consommation.resample<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'30T'</span><span style="color: #4f97d7;">)</span>.mean<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> column <span style="color: #4f97d7; font-weight: bold;">in</span> cons.columns:
    <span style="color: #7590db;">col</span> = i % <span style="color: #a45bad;">3</span>
    cons<span style="color: #4f97d7;">[</span>column<span style="color: #4f97d7;">]</span>.plot<span style="color: #4f97d7;">(</span>ax=ax<span style="color: #bc6ec5;">[</span>row, col<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">i</span> += <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> col == <span style="color: #a45bad;">2</span>:
        <span style="color: #7590db;">row</span> += <span style="color: #a45bad;">1</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/plotSeries.png" alt="plotSeries.png" />
</p>
</div>

<p>
In order to make sure we are using
clean data, I have selected all records from the 2nd of January 2013 (1st
doesn't have data for midnight) to the 2nd of January 2017.
</p>

<p>
Furthermore, a second pivot table was used in order to create a column for each
30 minutes of the day. This resulted in a table composed of 576 daily time
series (48 for each of the 12 regions
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> datetime

<span style="color: #7590db;">consommation</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"date"</span><span style="color: #4f97d7;">]</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>consommation.index<span style="color: #4f97d7;">)</span>.date
<span style="color: #7590db;">consommation</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"time"</span><span style="color: #4f97d7;">]</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>consommation.index<span style="color: #4f97d7;">)</span>.time
<span style="color: #7590db;">consommation</span> = pd.pivot_table<span style="color: #4f97d7;">(</span>pd.melt<span style="color: #bc6ec5;">(</span>consommation, id_vars=<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"date"</span>, <span style="color: #2d9574;">"time"</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>,
                              index=<span style="color: #2d9574;">"date"</span>, values=<span style="color: #2d9574;">"value"</span>, columns=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"P&#233;rim&#232;tre"</span>, <span style="color: #2d9574;">"time"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">consommation</span> = consommation.loc<span style="color: #4f97d7;">[</span>datetime.date<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2013</span>,<span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>:datetime.date<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2017</span>,<span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>, :<span style="color: #4f97d7;">]</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Get rid of the 15 minutes columns (columns with nans)</span>
<span style="color: #7590db;">consommation</span> = consommation.loc<span style="color: #4f97d7;">[</span>:,consommation.isnull<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #bc6ec5;">()</span>!=consommation.shape<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span>

consommation.head<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
Périmètre  Auvergne-Rhône-Alpes                                               \
time                   00:00:00 00:30:00 01:00:00 01:30:00 02:00:00 02:30:00
date
2013-01-02               7847.0   7674.0   7427.0   7441.0   7467.0   7550.0
2013-01-03               9028.0   8839.0   8544.0   8560.0   8569.0   8667.0
2013-01-04               8982.0   8754.0   8476.0   8480.0   8453.0   8554.0
2013-01-05               8625.0   8465.0   8165.0   8134.0   8087.0   8149.0
2013-01-06               8314.0   8097.0   7814.0   7791.0   7785.0   7842.0

Périmètre                                        ...    Pays-de-la-Loire  \
time       03:00:00 03:30:00 04:00:00 04:30:00   ...            19:00:00
date                                             ...
2013-01-02   7434.0   7371.0   7233.0   7311.0   ...              4336.0
2013-01-03   8559.0   8483.0   8390.0   8392.0   ...              4279.0
2013-01-04   8436.0   8386.0   8224.0   8195.0   ...              4181.0
2013-01-05   7974.0   7897.0   7713.0   7597.0   ...              3877.0
2013-01-06   7670.0   7605.0   7418.0   7352.0   ...              3854.0

Périmètre                                                                  \
time       19:30:00 20:00:00 20:30:00 21:00:00 21:30:00 22:00:00 22:30:00
date
2013-01-02   4228.0   4079.0   3923.0   3756.0   3565.0   3457.0   3510.0
2013-01-03   4166.0   4038.0   3862.0   3712.0   3463.0   3308.0   3394.0
2013-01-04   4123.0   3946.0   3755.0   3597.0   3559.0   3412.0   3456.0
2013-01-05   3786.0   3696.0   3540.0   3449.0   3296.0   3221.0   3296.0
2013-01-06   3834.0   3826.0   3771.0   3631.0   3494.0   3423.0   3420.0

Périmètre
time       23:00:00 23:30:00
date
2013-01-02   4003.0   3710.0
2013-01-03   3909.0   3700.0
2013-01-04   3903.0   3662.0
2013-01-05   3864.0   3700.0
2013-01-06   3942.0   3717.0

[5 rows x 576 columns]
</pre>

<p>
With minimal data manipulation, I was able to format the data into 48 daily
series for each of the regions and get rid of all the 'missing' values.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Data dimensions: '</span>, consommation.shape<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Number of NA values: '</span>, consommation.isnull<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Data dimensions:  (1455, 576)
Number of NA values:  0

</pre>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Save to access from R</span>
consommation.to_csv<span style="color: #4f97d7;">(</span>join<span style="color: #bc6ec5;">(</span>data_path, <span style="color: #2d9574;">"consommation.csv"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">consommation</span> = pd.read_csv<span style="color: #4f97d7;">(</span>join<span style="color: #bc6ec5;">(</span>data_path, <span style="color: #2d9574;">"consommation.csv"</span><span style="color: #bc6ec5;">)</span>,index_col=<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, header=<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

consommation.head<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
Périmètre  Auvergne-Rhône-Alpes                                               \
time                   00:00:00 00:30:00 01:00:00 01:30:00 02:00:00 02:30:00
date
2013-01-02               7847.0   7674.0   7427.0   7441.0   7467.0   7550.0
2013-01-03               9028.0   8839.0   8544.0   8560.0   8569.0   8667.0
2013-01-04               8982.0   8754.0   8476.0   8480.0   8453.0   8554.0
2013-01-05               8625.0   8465.0   8165.0   8134.0   8087.0   8149.0
2013-01-06               8314.0   8097.0   7814.0   7791.0   7785.0   7842.0

Périmètre                                        ...    Pays-de-la-Loire  \
time       03:00:00 03:30:00 04:00:00 04:30:00   ...            19:00:00
date                                             ...
2013-01-02   7434.0   7371.0   7233.0   7311.0   ...              4336.0
2013-01-03   8559.0   8483.0   8390.0   8392.0   ...              4279.0
2013-01-04   8436.0   8386.0   8224.0   8195.0   ...              4181.0
2013-01-05   7974.0   7897.0   7713.0   7597.0   ...              3877.0
2013-01-06   7670.0   7605.0   7418.0   7352.0   ...              3854.0

Périmètre                                                                  \
time       19:30:00 20:00:00 20:30:00 21:00:00 21:30:00 22:00:00 22:30:00
date
2013-01-02   4228.0   4079.0   3923.0   3756.0   3565.0   3457.0   3510.0
2013-01-03   4166.0   4038.0   3862.0   3712.0   3463.0   3308.0   3394.0
2013-01-04   4123.0   3946.0   3755.0   3597.0   3559.0   3412.0   3456.0
2013-01-05   3786.0   3696.0   3540.0   3449.0   3296.0   3221.0   3296.0
2013-01-06   3834.0   3826.0   3771.0   3631.0   3494.0   3423.0   3420.0

Périmètre
time       23:00:00 23:30:00
date
2013-01-02   4003.0   3710.0
2013-01-03   3909.0   3700.0
2013-01-04   3903.0   3662.0
2013-01-05   3864.0   3700.0
2013-01-06   3942.0   3717.0

[5 rows x 576 columns]
</pre>
</div>
</div>


<div id="outline-container-org1ea7564" class="outline-4">
<h4 id="org1ea7564"><span class="section-number-4">1.1.2</span> In R (NOT USED ANYMORE!)</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>tidyverse<span style="color: #4f97d7;">)</span>
<span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>lubridate<span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">data <span style="color: #a45bad;">&lt;-</span> read.csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"data/all_raw.csv"</span>, row.names=<span style="color: #ce537a; font-weight: bold;">NULL</span>, encoding=<span style="color: #2d9574;">"cp1252"</span><span style="color: #4f97d7;">)</span>
data$Date <span style="color: #a45bad;">&lt;-</span> parse_date<span style="color: #4f97d7;">(</span>data$Date<span style="color: #4f97d7;">)</span>
data$Heures <span style="color: #a45bad;">&lt;-</span> parse_time<span style="color: #4f97d7;">(</span>data$Heures<span style="color: #4f97d7;">)</span>
data$Consommation <span style="color: #a45bad;">&lt;-</span> data$Consommation <span style="color: #a45bad;">%&gt;%</span>
  as.character<span style="color: #4f97d7;">()</span> <span style="color: #a45bad;">%&gt;%</span>
  parse_double<span style="color: #4f97d7;">(</span>na = c<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">""</span>, <span style="color: #2d9574;">"NA"</span>, <span style="color: #2d9574;">"-"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

data <span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  select<span style="color: #4f97d7;">(</span>c<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"P&#233;rim&#232;tre"</span>, <span style="color: #2d9574;">"Consommation"</span>, <span style="color: #2d9574;">"Date"</span>, <span style="color: #2d9574;">"Heures"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #a45bad;">%&gt;%</span>
  filter<span style="color: #4f97d7;">(</span>P&#233;rim&#232;tre != <span style="color: #2d9574;">"France"</span><span style="color: #4f97d7;">)</span>

goodRegions <span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  spread<span style="color: #4f97d7;">(</span>key=P&#233;rim&#232;tre, value = Consommation<span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
  is.na<span style="color: #4f97d7;">()</span> <span style="color: #a45bad;">%&gt;%</span>
  colMeans<span style="color: #4f97d7;">()</span> &lt; <span style="color: #a45bad;">0.5</span>

goodRegions<span style="color: #a45bad;">&lt;-</span> names<span style="color: #4f97d7;">(</span>which<span style="color: #bc6ec5;">(</span>goodRegions<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
data <span style="color: #a45bad;">&lt;-</span> data<span style="color: #4f97d7;">[</span>data$P&#233;rim&#232;tre <span style="color: #a45bad;">%in%</span> goodRegions, <span style="color: #4f97d7;">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #a45bad;">library</span><span style="color: #4f97d7;">(</span>xts<span style="color: #4f97d7;">)</span>

data.byPerimetre<span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  spread<span style="color: #4f97d7;">(</span>key=P&#233;rim&#232;tre, value=Consommation<span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
  filter<span style="color: #4f97d7;">(</span>Date &gt; ymd<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"2013-01-01"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

dates <span style="color: #a45bad;">&lt;-</span> as.POSIXct<span style="color: #4f97d7;">(</span>paste<span style="color: #bc6ec5;">(</span>data.byPerimetre$Date, data.byPerimetre$Heures<span style="color: #bc6ec5;">)</span>, format=<span style="color: #2d9574;">"%Y-%m-%d %H:%M:%S"</span>, tz=<span style="color: #2d9574;">"UTC"</span><span style="color: #4f97d7;">)</span>
regions.xts <span style="color: #a45bad;">&lt;-</span> xts<span style="color: #4f97d7;">(</span>data.matrix<span style="color: #bc6ec5;">(</span>data.byPerimetre<span style="color: #2d9574;">[</span>, c<span style="color: #67b11d;">(</span>-<span style="color: #a45bad;">1</span>,-<span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>,order.by=dates<span style="color: #4f97d7;">)</span>

ep <span style="color: #a45bad;">&lt;-</span> endpoints<span style="color: #4f97d7;">(</span>regions.xts, <span style="color: #2d9574;">"minutes"</span>, k=<span style="color: #a45bad;">30</span><span style="color: #4f97d7;">)</span>
halfHour.xts <span style="color: #a45bad;">&lt;-</span> period.apply<span style="color: #4f97d7;">(</span>na.locf<span style="color: #bc6ec5;">(</span>regions.xts<span style="color: #bc6ec5;">)</span>, INDEX = ep, FUN = mean<span style="color: #4f97d7;">)</span>

plot.xts<span style="color: #4f97d7;">(</span>halfHour.xts<span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/r_xts_outliers.png" alt="r_xts_outliers.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">From 1st of september 2017, we get 15 minutes measurements</span>
data.byPerimetre<span style="color: #a45bad;">&lt;-</span> data <span style="color: #a45bad;">%&gt;%</span>
  spread<span style="color: #4f97d7;">(</span>key=P&#233;rim&#232;tre, value=Consommation<span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
  filter<span style="color: #4f97d7;">(</span>Date &gt; ymd<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"2013-01-01"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> <span style="color: #a45bad;">%&gt;%</span>
    filter<span style="color: #4f97d7;">(</span>Date &lt; ymd<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"2017-09-01"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

dates <span style="color: #a45bad;">&lt;-</span> as.POSIXct<span style="color: #4f97d7;">(</span>paste<span style="color: #bc6ec5;">(</span>data.byPerimetre$Date, data.byPerimetre$Heures<span style="color: #bc6ec5;">)</span>, format=<span style="color: #2d9574;">"%Y-%m-%d %H:%M:%S"</span>, tz=<span style="color: #2d9574;">"UTC"</span><span style="color: #4f97d7;">)</span>
regions.xts <span style="color: #a45bad;">&lt;-</span> xts<span style="color: #4f97d7;">(</span>data.matrix<span style="color: #bc6ec5;">(</span>data.byPerimetre<span style="color: #2d9574;">[</span>, c<span style="color: #67b11d;">(</span>-<span style="color: #a45bad;">1</span>,-<span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>,order.by=dates<span style="color: #4f97d7;">)</span>

ep <span style="color: #a45bad;">&lt;-</span> endpoints<span style="color: #4f97d7;">(</span>regions.xts, <span style="color: #2d9574;">"minutes"</span>, k=<span style="color: #a45bad;">30</span><span style="color: #4f97d7;">)</span>
halfHour.xts <span style="color: #a45bad;">&lt;-</span> period.apply<span style="color: #4f97d7;">(</span>na.locf<span style="color: #bc6ec5;">(</span>regions.xts<span style="color: #bc6ec5;">)</span>, INDEX = ep, FUN = mean<span style="color: #4f97d7;">)</span>

plot.xts<span style="color: #4f97d7;">(</span>halfHour.xts<span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/r_xts.png" alt="r_xts.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-R"><span style="color: #bc6ec5; font-weight: bold;">tHourly</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span><span style="color: #4f97d7;">(</span>x<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">print(index(x[1]))</span>
  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">initialize result matrix for all 48 half-hour</span>
  dnames <span style="color: #a45bad;">&lt;-</span> list<span style="color: #bc6ec5;">(</span>paste0<span style="color: #2d9574;">(</span>date<span style="color: #67b11d;">(</span>index<span style="color: #b1951d;">(</span>x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>,
                 paste0<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"H"</span>, seq<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">23.5</span>,<span style="color: #a45bad;">0.5</span><span style="color: #67b11d;">)</span>, rep<span style="color: #67b11d;">(</span>colnames<span style="color: #b1951d;">(</span>x<span style="color: #b1951d;">)</span>, each = <span style="color: #a45bad;">48</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  res <span style="color: #a45bad;">&lt;-</span> matrix<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">NA</span>, <span style="color: #a45bad;">1</span>, dim<span style="color: #2d9574;">(</span>x<span style="color: #2d9574;">)[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span> * <span style="color: #a45bad;">48</span>, dimnames = dnames<span style="color: #bc6ec5;">)</span>
  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">update result object and return</span>
  res<span style="color: #bc6ec5;">[</span>,<span style="color: #bc6ec5;">]</span> <span style="color: #a45bad;">&lt;-</span> unlist<span style="color: #bc6ec5;">(</span>split<span style="color: #2d9574;">(</span>t<span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span>, seq<span style="color: #67b11d;">(</span>ncol<span style="color: #b1951d;">(</span>x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  res
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">split on days, apply tHourly to each day, rbind results</span>
p_mat <span style="color: #a45bad;">&lt;-</span> split<span style="color: #4f97d7;">(</span>halfHour.xts, f=<span style="color: #2d9574;">"days"</span>, drop=<span style="color: #ce537a; font-weight: bold;">FALSE</span>, k=<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
p_list <span style="color: #a45bad;">&lt;-</span> lapply<span style="color: #4f97d7;">(</span>p_mat, tHourly<span style="color: #4f97d7;">)</span>
p_hmat <span style="color: #a45bad;">&lt;-</span> do.call<span style="color: #4f97d7;">(</span>rbind, p_list<span style="color: #4f97d7;">)</span>

head<span style="color: #4f97d7;">(</span>p_hmat<span style="color: #bc6ec5;">[</span>,<span style="color: #a45bad;">1</span>:<span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">H0Auvergne-Rhône-Alpes</th>
<th scope="col" class="org-right">H0.5Auvergne-Rhône-Alpes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2013-01-02</td>
<td class="org-right">7847</td>
<td class="org-right">7674</td>
</tr>

<tr>
<td class="org-right">2013-01-03</td>
<td class="org-right">9028</td>
<td class="org-right">8839</td>
</tr>

<tr>
<td class="org-right">2013-01-04</td>
<td class="org-right">8982</td>
<td class="org-right">8754</td>
</tr>

<tr>
<td class="org-right">2013-01-05</td>
<td class="org-right">8625</td>
<td class="org-right">8465</td>
</tr>

<tr>
<td class="org-right">2013-01-06</td>
<td class="org-right">8314</td>
<td class="org-right">8097</td>
</tr>

<tr>
<td class="org-right">2013-01-07</td>
<td class="org-right">8312</td>
<td class="org-right">8214</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">dim<span style="color: #4f97d7;">(</span>p_hmat<span style="color: #4f97d7;">)</span>
sum<span style="color: #4f97d7;">(</span>is.na<span style="color: #bc6ec5;">(</span>p_hmat<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
[1] 1703  576
[1] 0
</p>
</div>
</div>
</div>


<div id="outline-container-org6a6796d" class="outline-3">
<h3 id="org6a6796d"><span class="section-number-3">1.2</span> Transform the data</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-orgd2af660" class="outline-4">
<h4 id="orgd2af660"><span class="section-number-4">1.2.1</span> In Python</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> inspect

<span style="color: #4f97d7; font-weight: bold;">import</span> itertools
<span style="color: #4f97d7; font-weight: bold;">import</span> pickle
<span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">import</span> scipy.cluster.hierarchy <span style="color: #4f97d7; font-weight: bold;">as</span> hcl
<span style="color: #4f97d7; font-weight: bold;">from</span> scipy.spatial.distance <span style="color: #4f97d7; font-weight: bold;">import</span> squareform
<span style="color: #4f97d7; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #4f97d7; font-weight: bold;">import</span> adfuller, pacf    
<span style="color: #4f97d7; font-weight: bold;">import</span> statsmodels.tsa.ar_model <span style="color: #4f97d7; font-weight: bold;">as</span> ar
<span style="color: #4f97d7; font-weight: bold;">import</span> statsmodels.tsa.api <span style="color: #4f97d7; font-weight: bold;">as</span> smt

<span style="color: #4f97d7; font-weight: bold;">import</span> src.helpers <span style="color: #4f97d7; font-weight: bold;">as</span> helpers
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">consommation</span> = pd.read_csv<span style="color: #4f97d7;">(</span>join<span style="color: #bc6ec5;">(</span>data_path, <span style="color: #2d9574;">'consommation.csv'</span><span style="color: #bc6ec5;">)</span>, header=<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, index_col=<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
As all the series are daily values there is a strong weekly seasonality within
the values, shown here with a strong 7 days autocorrelation.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #4f97d7; font-weight: bold;">import</span> acf

plt.figure<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> columns <span style="color: #4f97d7; font-weight: bold;">in</span> consommation:
    plt.plot<span style="color: #4f97d7;">(</span>acf<span style="color: #bc6ec5;">(</span>consommation.loc<span style="color: #2d9574;">[</span>:,columns<span style="color: #2d9574;">]</span>.diff<span style="color: #2d9574;">(</span><span style="color: #a45bad;">7</span><span style="color: #2d9574;">)[</span><span style="color: #a45bad;">7</span>:<span style="color: #2d9574;">]</span>, nlags=<span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">05</span>, color=<span style="color: #2d9574;">"black"</span><span style="color: #4f97d7;">)</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Lag"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Autocorrelation"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'Autocorrelation')

</pre>

<div class="figure">
<p><img src="./img/7dayACF.png" alt="7dayACF.png" />
</p>
</div>

<p>
To remove that seasonality, the change from one day to the one 7days later was
calculated, making all of the 576 significantly stationary, as the maximum p
value observed using the Dickey-Fuller test is much less than 0.05 (with
magnitude order of 10<sup>-7</sup>).
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #4f97d7; font-weight: bold;">import</span> adfuller

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test_stationarity</span><span style="color: #4f97d7;">(</span>timeseries<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Perform Dickey-Fuller test:</span>
    <span style="color: #7590db;">dftest</span> = adfuller<span style="color: #4f97d7;">(</span>timeseries, autolag=<span style="color: #2d9574;">"AIC"</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">dfoutput</span> = pd.Series<span style="color: #4f97d7;">(</span>dftest<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>:<span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span>, index=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'Test Statistic'</span>, <span style="color: #2d9574;">'p-value'</span>, <span style="color: #2d9574;">'#Lags Used'</span>, <span style="color: #2d9574;">'Number of Observations Used'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> key, value <span style="color: #4f97d7; font-weight: bold;">in</span> dftest<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">]</span>.items<span style="color: #4f97d7;">()</span>:
        <span style="color: #7590db;">dfoutput</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'Critical Value (%s)'</span> % key<span style="color: #4f97d7;">]</span> = value
    <span style="color: #4f97d7; font-weight: bold;">return</span> dfoutput

<span style="color: #7590db;">consommation</span> = consommation.diff<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">7</span><span style="color: #4f97d7;">)[</span><span style="color: #a45bad;">7</span>:<span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">p_values</span> = consommation.<span style="color: #4f97d7;">apply</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: test_stationarity<span style="color: #bc6ec5;">(</span>x<span style="color: #bc6ec5;">)[</span><span style="color: #2d9574;">"p-value"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
p_values.<span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
2.1260321435185846e-07

</pre>

<p>
Here is the distribution of the inter-quantile p values. 
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> seaborn <span style="color: #4f97d7; font-weight: bold;">as</span> sns
sns.distplot<span style="color: #4f97d7;">(</span>p_values<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">(</span>p_values &gt; p_values.quantile<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">25</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &amp; <span style="color: #2d9574;">(</span>p_values &lt; p_values.quantile<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">75</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span>, kde=<span style="color: #a45bad;">False</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
&lt;matplotlib.axes._subplots.AxesSubplot at 0x11d25cb00&gt;

</pre>

<div class="figure">
<p><img src="pValuesStationarity.png" alt="pValuesStationarity.png" />
</p>
</div>



<p>
Data was transformed using z-score and weekly differential
</p>


<p>
\[z = \frac{x - \mu}{\sigma}\]
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> scipy.stats.mstats <span style="color: #4f97d7; font-weight: bold;">import</span> zscore
<span style="color: #7590db;">consommation</span> = consommation.<span style="color: #4f97d7;">apply</span><span style="color: #4f97d7;">(</span>zscore, axis=<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Mean of z score is between'</span>, consommation.mean<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">min</span><span style="color: #bc6ec5;">()</span>, <span style="color: #2d9574;">' and '</span>, consommation.mean<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
Mean of z score is between -2.33490203117e-16  and  6.55298648487e-16
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Std of z score is between'</span>, consommation.std<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">min</span><span style="color: #bc6ec5;">()</span>, <span style="color: #2d9574;">' and '</span>, consommation.std<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
Std of z score is between 1.00034381985  and  1.00034381985
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org5bc4ccd" class="outline-2">
<h2 id="org5bc4ccd"><span class="section-number-2">2</span> Calculation of GCC</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">gets the lag first lags that gives negative pacf</span>
<span style="color: #7590db;">k</span> = np.<span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>np.where<span style="color: #2d9574;">(</span>pacf<span style="color: #67b11d;">(</span>consommation.loc<span style="color: #b1951d;">[</span>:, colname<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">][</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> colname, col <span style="color: #4f97d7; font-weight: bold;">in</span> consommation.iteritems<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
k
</pre>
</div>

<pre class="example">
5

</pre>

<p>
Tried with max lag 40 but the GCC computation failed
</p>
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">k</span> = consommation.<span style="color: #4f97d7;">apply</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: ar.AR<span style="color: #bc6ec5;">(</span>x<span style="color: #bc6ec5;">)</span>.select_order<span style="color: #bc6ec5;">(</span>maxlag=<span style="color: #a45bad;">40</span>, ic=<span style="color: #2d9574;">"bic"</span>, trend=<span style="color: #2d9574;">"nc"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>.<span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">()</span>
k
</pre>
</div>

<pre class="example">
: 38

</pre>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">k</span>=<span style="color: #a45bad;">17</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>inspect.getsource<span style="color: #bc6ec5;">(</span>helpers.k_matrix<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">k_matrix</span><span style="color: #4f97d7;">(</span>ts, k<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> np.array<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>ts<span style="color: #2d9574;">[</span><span style="color: #67b11d;">(</span>shift<span style="color: #67b11d;">)</span>:ts.shape<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> - k + shift<span style="color: #2d9574;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> shift <span style="color: #4f97d7; font-weight: bold;">in</span> np.arange<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, k + <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>.T

</pre>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>inspect.getsource<span style="color: #bc6ec5;">(</span>helpers.get_GCC<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">get_GCC</span><span style="color: #4f97d7;">(</span>ts1, ts2, k<span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">Xi</span> = k_matrix<span style="color: #4f97d7;">(</span>ts1, k<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">Xj</span> = k_matrix<span style="color: #4f97d7;">(</span>ts2, k<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">Xij</span> = np.concatenate<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>Xi, Xj<span style="color: #bc6ec5;">)</span>, axis=<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">GCC</span> = <span style="color: #a45bad;">1</span> - np.linalg.det<span style="color: #4f97d7;">(</span>np.corrcoef<span style="color: #bc6ec5;">(</span>Xij, rowvar=<span style="color: #a45bad;">False</span><span style="color: #bc6ec5;">)</span> ** <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span> / <span style="color: #a45bad;">2</span> * <span style="color: #2d9574;">(</span>k + <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> / <span style="color: #4f97d7;">(</span>
        np.linalg.det<span style="color: #bc6ec5;">(</span>np.corrcoef<span style="color: #2d9574;">(</span>Xi, rowvar=<span style="color: #a45bad;">False</span><span style="color: #2d9574;">)</span> ** <span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span> / <span style="color: #a45bad;">2</span> * <span style="color: #67b11d;">(</span>k + <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> \
        * np.linalg.det<span style="color: #bc6ec5;">(</span>np.corrcoef<span style="color: #2d9574;">(</span>Xj, rowvar=<span style="color: #a45bad;">False</span><span style="color: #2d9574;">)</span> ** <span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span> / <span style="color: #a45bad;">2</span> * <span style="color: #67b11d;">(</span>k + <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> GCC

</pre>
</div>

<p>
Then trying a few different ways of calculation the correlation matrix, I am
struggling to get a correct value for GCC:
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">DM_GCC</span> = np.zeros<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>consommation.shape<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, consommation.shape<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> i, j <span style="color: #4f97d7; font-weight: bold;">in</span> itertools.combinations<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">range</span><span style="color: #bc6ec5;">(</span>consommation.shape<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">DM_GCC</span><span style="color: #4f97d7;">[</span>i, j<span style="color: #4f97d7;">]</span> = <span style="color: #7590db;">DM_GCC</span><span style="color: #4f97d7;">[</span>j, i<span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">1</span> - helpers.get_GCC<span style="color: #4f97d7;">(</span>consommation.iloc<span style="color: #bc6ec5;">[</span>:, i<span style="color: #bc6ec5;">]</span>, consommation.iloc<span style="color: #bc6ec5;">[</span>:, j<span style="color: #bc6ec5;">]</span>, k<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">DM_GCC</span> = pd.DataFrame<span style="color: #4f97d7;">(</span>DM_GCC, index=consommation.columns, columns=consommation.columns<span style="color: #4f97d7;">)</span>

pickle.dump<span style="color: #4f97d7;">(</span>DM_GCC, <span style="color: #4f97d7;">open</span><span style="color: #bc6ec5;">(</span>join<span style="color: #2d9574;">(</span>data_path, <span style="color: #2d9574;">"DM_GCC_17.p"</span><span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"wb"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga50a1a5" class="outline-2">
<h2 id="orga50a1a5"><span class="section-number-2">3</span> Clustering</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgad6ddd3" class="outline-3">
<h3 id="orgad6ddd3"><span class="section-number-3">3.1</span> Determination of the number of clusters</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">linkage</span> = hcl.linkage<span style="color: #4f97d7;">(</span>squareform<span style="color: #bc6ec5;">(</span>DM_GCC<span style="color: #bc6ec5;">)</span>, method=<span style="color: #2d9574;">"average"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.figure<span style="color: #4f97d7;">()</span>
plt.plot<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">range</span><span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>, <span style="color: #4f97d7;">len</span><span style="color: #2d9574;">(</span>linkage<span style="color: #2d9574;">)</span>+<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>, linkage<span style="color: #bc6ec5;">[</span>::-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlim<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">20</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
ax.set_ylim<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Number of clusters"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Between clusters distance"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'Between clusters distance')

</pre>

<div class="figure">
<p><img src="./img/elbow.png" alt="elbow.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">elbow</span> = np.diff<span style="color: #4f97d7;">(</span>linkage<span style="color: #bc6ec5;">[</span>::-<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">n_clust1</span> = elbow.argmax<span style="color: #4f97d7;">()</span>+<span style="color: #a45bad;">2</span>
<span style="color: #7590db;">elbow</span><span style="color: #4f97d7;">[</span>elbow.argmax<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">0</span>
<span style="color: #7590db;">n_clust2</span> = elbow.argmax<span style="color: #4f97d7;">()</span>+<span style="color: #a45bad;">2</span>
<span style="color: #4f97d7;">[</span>n_clust1, n_clust2<span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4f1cdc9" class="outline-3">
<h3 id="org4f1cdc9"><span class="section-number-3">3.2</span> Clustering methods comparison</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.manifold <span style="color: #4f97d7; font-weight: bold;">import</span> TSNE
<span style="color: #7590db;">n_clusters</span> = n_clust1
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">tsne_2dim</span> = TSNE<span style="color: #4f97d7;">(</span>n_components=<span style="color: #a45bad;">2</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_transform<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust1_TSNE.png" alt="n_clust1_TSNE.png" />
</p>
</div>



<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">n_clusters</span> = n_clust2
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">tsne_2dim</span> = TSNE<span style="color: #4f97d7;">(</span>n_components=<span style="color: #a45bad;">2</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_transform<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust2_TSNE.png" alt="n_clust2_TSNE.png" />
</p>
</div>



<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.cluster <span style="color: #4f97d7; font-weight: bold;">import</span> SpectralClustering

<span style="color: #7590db;">n_clusters</span> = n_clust1
<span style="color: #7590db;">clusters</span> = SpectralClustering<span style="color: #4f97d7;">(</span>n_clusters, affinity=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_predict<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">tsne_2dim</span> = TSNE<span style="color: #4f97d7;">(</span>n_components=<span style="color: #a45bad;">2</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_transform<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust1_spectral.png" alt="n_clust1_spectral.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.cluster <span style="color: #4f97d7; font-weight: bold;">import</span> SpectralClustering

<span style="color: #7590db;">n_clusters</span> = n_clust2
<span style="color: #7590db;">clusters</span> = SpectralClustering<span style="color: #4f97d7;">(</span>n_clusters, affinity=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_predict<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">tsne_2dim</span> = TSNE<span style="color: #4f97d7;">(</span>n_components=<span style="color: #a45bad;">2</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_transform<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust2_spectral.png" alt="n_clust2_spectral.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.cluster <span style="color: #4f97d7; font-weight: bold;">import</span> KMeans

<span style="color: #7590db;">n_clusters</span> = n_clust1
<span style="color: #7590db;">eigen_values</span>, <span style="color: #7590db;">eigen_vectors</span> = np.linalg.eigh<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">clusters</span> = KMeans<span style="color: #4f97d7;">(</span>n_clusters=n_clusters, init=<span style="color: #2d9574;">'k-means++'</span><span style="color: #4f97d7;">)</span>.fit_predict<span style="color: #4f97d7;">(</span>eigen_vectors<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">2</span>:<span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust1_kmeans.png" alt="n_clust1_kmeans.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.cluster <span style="color: #4f97d7; font-weight: bold;">import</span> KMeans

<span style="color: #7590db;">n_clusters</span> = n_clust2
<span style="color: #7590db;">eigen_values</span>, <span style="color: #7590db;">eigen_vectors</span> = np.linalg.eigh<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">clusters</span> = KMeans<span style="color: #4f97d7;">(</span>n_clusters=n_clusters, init=<span style="color: #2d9574;">'k-means++'</span><span style="color: #4f97d7;">)</span>.fit_predict<span style="color: #4f97d7;">(</span>eigen_vectors<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">2</span>:<span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

plt.figure<span style="color: #4f97d7;">()</span>
plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust2_kmeans.png" alt="n_clust2_kmeans.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.cluster <span style="color: #4f97d7; font-weight: bold;">import</span> DBSCAN

<span style="color: #4f97d7; font-weight: bold;">for</span> eps <span style="color: #4f97d7; font-weight: bold;">in</span> np.arange<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0001</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">01</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0001</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">clusters</span> = DBSCAN<span style="color: #4f97d7;">(</span>eps=eps, min_samples=<span style="color: #a45bad;">10</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_predict<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">n_clusters</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>np.unique<span style="color: #bc6ec5;">(</span>clusters<span style="color: #2d9574;">[</span>clusters&gt;<span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> n_clusters == n_clust1:
      plt.figure<span style="color: #4f97d7;">()</span>
      plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
      <span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
      ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
      ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
      <span style="color: #4f97d7; font-weight: bold;">break</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust1_dbscan.png" alt="n_clust1_dbscan.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.cluster <span style="color: #4f97d7; font-weight: bold;">import</span> DBSCAN

<span style="color: #4f97d7; font-weight: bold;">for</span> eps <span style="color: #4f97d7; font-weight: bold;">in</span> np.arange<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0001</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">01</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0001</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">clusters</span> = DBSCAN<span style="color: #4f97d7;">(</span>eps=eps, min_samples=<span style="color: #a45bad;">10</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_predict<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">n_clusters</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>np.unique<span style="color: #bc6ec5;">(</span>clusters<span style="color: #2d9574;">[</span>clusters&gt;<span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> n_clusters == n_clust2:
      plt.figure<span style="color: #4f97d7;">()</span>
      plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
      <span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
      ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
      ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
      <span style="color: #4f97d7; font-weight: bold;">break</span>
</pre>
</div>

<pre class="example">
Text(0,0.5,'y-tsne')

</pre>

<div class="figure">
<p><img src="./img/n_clust2_dbscan.png" alt="n_clust2_dbscan.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.cluster <span style="color: #4f97d7; font-weight: bold;">import</span> DBSCAN

<span style="color: #4f97d7; font-weight: bold;">for</span> eps <span style="color: #4f97d7; font-weight: bold;">in</span> np.arange<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0001</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">01</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0001</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">clusters</span> = DBSCAN<span style="color: #4f97d7;">(</span>eps=eps, min_samples=<span style="color: #a45bad;">10</span>, metric=<span style="color: #2d9574;">"precomputed"</span><span style="color: #4f97d7;">)</span>.fit_predict<span style="color: #4f97d7;">(</span>DM_GCC<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">n_clusters</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>np.unique<span style="color: #bc6ec5;">(</span>clusters<span style="color: #2d9574;">[</span>clusters&gt;<span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> n_clusters == <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>np.unique<span style="color: #bc6ec5;">(</span>consommation.columns.get_level_values<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"P&#233;rim&#232;tre"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>:
        plt.figure<span style="color: #4f97d7;">()</span>
        plt.scatter<span style="color: #4f97d7;">(</span>tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, tsne_2dim<span style="color: #bc6ec5;">[</span>:, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, c=clusters, cmap=plt.cm.get_cmap<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Paired'</span>, n_clusters<span style="color: #bc6ec5;">)</span>, alpha=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
        <span style="color: #7590db;">ax</span> = plt.gca<span style="color: #4f97d7;">()</span>
        ax.set_xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"x-tsne"</span><span style="color: #4f97d7;">)</span>
        ax.set_ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"y-tsne"</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">break</span>

</pre>
</div>


<div class="figure">
<p><img src="./img/regions_dbscan.png" alt="regions_dbscan.png" />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org84b489d" class="outline-2">
<h2 id="org84b489d"><span class="section-number-2">4</span> Mapping the clusters</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">n_clusters</span> = n_clust2
<span style="color: #7590db;">clusters</span> = hcl.fcluster<span style="color: #4f97d7;">(</span>linkage, t=n_clusters, criterion=<span style="color: #2d9574;">"maxclust"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">consommation_clusters</span> = pd.DataFrame<span style="color: #4f97d7;">(</span>np.transpose<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span><span style="color: #67b11d;">[</span>series<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> series <span style="color: #4f97d7; font-weight: bold;">in</span> consommation.columns.values<span style="color: #67b11d;">]</span>,
                                                  <span style="color: #67b11d;">[</span>series<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> series <span style="color: #4f97d7; font-weight: bold;">in</span> consommation.columns.values<span style="color: #67b11d;">]</span>,
                                                  <span style="color: #4f97d7;">list</span><span style="color: #67b11d;">(</span>clusters<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>, columns=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Region"</span>, <span style="color: #2d9574;">"Time"</span>, <span style="color: #2d9574;">"Cluster"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">region_cluster</span> = consommation_clusters.groupby<span style="color: #4f97d7;">(</span>by=<span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">)[</span><span style="color: #2d9574;">"Cluster"</span><span style="color: #4f97d7;">]</span>.value_counts<span style="color: #4f97d7;">()</span>.index.to_frame<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">region_cluster.index</span> = region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">]</span>.values

<span style="color: #7590db;">region_codes</span> = pd.read_csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"./data/frenchRegions.csv"</span><span style="color: #4f97d7;">)</span>

region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">]</span>.isin<span style="color: #4f97d7;">(</span>region_codes<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">region_cluster</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"region_match"</span><span style="color: #4f97d7;">]</span> = region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Region"</span><span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">region_codes</span> = <span style="color: #4f97d7;">{}</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Auvergne-Rh&#244;ne-Alpes"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">83</span>, <span style="color: #a45bad;">82</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Bourgogne-Franche-Comt&#233;"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">26</span>, <span style="color: #a45bad;">43</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Bretagne"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">53</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Centre-Val de Loire"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">24</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Grand-Est"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">42</span>, <span style="color: #a45bad;">21</span>, <span style="color: #a45bad;">41</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Hauts-de-France"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">31</span>, <span style="color: #a45bad;">22</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Ile-de-France"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">11</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Normandie"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">23</span>, <span style="color: #a45bad;">25</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Nouvelle-Aquitaine"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">72</span>, <span style="color: #a45bad;">54</span>, <span style="color: #a45bad;">74</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Occitanie"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">91</span>, <span style="color: #a45bad;">73</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"PACA"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">93</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">region_codes</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Pays-de-la-Loire"</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">52</span><span style="color: #4f97d7;">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span>  pygal
<span style="color: #4f97d7; font-weight: bold;">from</span> itertools <span style="color: #4f97d7; font-weight: bold;">import</span> chain

<span style="color: #7590db;">fr_chart</span> = pygal.maps.fr.Regions<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">fr_chart.title</span> = <span style="color: #2d9574;">'Regions clusters'</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> cluster <span style="color: #4f97d7; font-weight: bold;">in</span> np.unique<span style="color: #4f97d7;">(</span>region_cluster<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"Cluster"</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>:
    fr_chart.add<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Cluster "</span> + <span style="color: #4f97d7;">str</span><span style="color: #bc6ec5;">(</span>cluster<span style="color: #bc6ec5;">)</span>, 
                 <span style="color: #4f97d7;">list</span><span style="color: #bc6ec5;">(</span>chain.from_iterable<span style="color: #2d9574;">(</span><span style="color: #67b11d;">[</span>region_codes<span style="color: #b1951d;">[</span>region<span style="color: #b1951d;">]</span> 
                                           <span style="color: #4f97d7; font-weight: bold;">for</span> region <span style="color: #4f97d7; font-weight: bold;">in</span> region_cluster.loc<span style="color: #b1951d;">[</span>
                                               region_cluster<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"Cluster"</span><span style="color: #4f97d7;">]</span>==cluster, <span style="color: #2d9574;">"Region"</span><span style="color: #b1951d;">]</span>.values<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
fr_chart.render_to_file<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"./img/regions_clusters.svg"</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><object type="image/svg+xml" data="./img/regions_clusters.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>
</div>
</div>

<div id="outline-container-org7ce8824" class="outline-2">
<h2 id="org7ce8824"><span class="section-number-2">5</span> Check within regions clusters</h2>
</div>


<div id="outline-container-org881f6a1" class="outline-2">
<h2 id="org881f6a1"><span class="section-number-2">6</span> References:</h2>
<div class="outline-text-2" id="text-6">
<p>
Ando, T. and Bai, J. (2016) Clustering huge number of financial time series: A panel data approach with high-dimensional predictors and factor structures. To appear at JASA. Available at: <a href="http://dx.doi.org/10.1080/01621459.2016.1195743">http://dx.doi.org/10.1080/01621459.2016.1195743</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Pierre Mercatoris</p>
<p class="date">Created: 2018-01-12 Fri 23:16</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
